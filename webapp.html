<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daggerheart</title>
    <script src="https://telegram.org/js/telegram-web-app.js?57"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 10px;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #0088cc);
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--tg-theme-hint-color, #666666);
            font-size: 14px;
        }

        .card {
            background: var(--tg-theme-secondary-bg-color, #f7f7f7);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 8px;
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
        }

        .button {
            display: block;
            width: 100%;
            padding: 12px 16px;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 8px;
            transition: opacity 0.2s;
        }

        .button:hover {
            opacity: 0.8;
        }

        .button.secondary {
            background: var(--tg-theme-secondary-bg-color, #f7f7f7);
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
        }

        .hidden {
            display: none !important;
        }

        .character-card {
            display: flex;
            gap: 16px;
            margin-bottom: 8px;
            align-items: flex-start;
        }

        .character-portrait {
            flex-shrink: 0;
            margin-top: 30px; 
        }

        .character-portrait img {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            border: 3px solid var(--tg-theme-button-color, #0088cc);
            object-fit: cover;
            background: var(--tg-theme-secondary-bg-color, #f7f7f7);
        }

        .character-info {
            flex: 1;
            min-width: 0;
        }

        .form-group {
            margin-bottom: 0px;
        }

        .form-label {
            display: block;
            margin-top: 3%;
            margin-bottom: 2%;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
            border-radius: 8px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
        }

        .gender-row-wrapper {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 0px;
            margin-right: 28px;
        }

        .gender-selector {
            display: flex;
            flex-direction: row;
            gap: 8px;
            justify-content: center;
            align-items: center;
            width: 100%;  
        }

        .gender-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 0px;
            background: none;
            border: none;
            border-radius: 8px;
            min-width: 90px;
            max-width: 90px;
            width: 90px; 
            box-sizing: border-box;
            margin-right: 28px;
        }

        .gender-slot .stat-label {
            font-size: 16px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
            text-align: center;
            line-height: 1.2;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 2px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 11px 16px;
            border-radius: 8px;
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
            background: var(--tg-theme-bg-color, #ffffff);
            transition: all 0.2s;
        }

        .radio-option:hover {
            background: var(--tg-theme-section-bg-color, #f0f0f0);
        }

        .radio-option input[type="radio"] {
            margin: 0;
        }

        .info-button {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }

        .stat-item {
            text-align: center;
            padding: 5px;
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            border-radius: 8px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--tg-theme-text-color, #000000);
        }

        .stat-value[readonly] {
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            color: var(--tg-theme-text-color, #000000);
            display: flex;
            align-items: center;
            justify-content: center;
        }

    /* Стили для модальных окон */

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: var(--tg-theme-bg-color, #ffffff);
            margin: 10% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--tg-theme-text-color, #000000);
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--tg-theme-hint-color, #666666);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-button:hover {
            color: var(--tg-theme-text-color, #000000);
        }

    /* Стили для модального окна пончиков */
    
        .notification-modal {
            display: none;
            position: fixed;
            z-index: 1500;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s ease;
        }

        .notification-content {
            background-color: var(--tg-theme-bg-color, #ffffff);
            margin: 20% auto;
            padding: 24px;
            border-radius: 16px;
            width: 85%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .notification-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #0088cc);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .notification-text {
            color: var(--tg-theme-text-color, #000000);
            line-height: 1.5;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .notification-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .notification-button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
            min-width: 100px;
        }

        .notification-button.primary {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .notification-button.secondary {
            background: var(--tg-theme-secondary-bg-color, #f7f7f7);
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
        }

        .notification-button:hover {
            opacity: 0.8;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .donut-icon {
            display: inline-block;
            font-size: 18px;
        }

        /* Стили для курсора пончиков */
        .stat-value[readonly] {
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            color: var(--tg-theme-text-color, #000000);
            cursor: pointer; /* Добавляем курсор указатель */
        }

        .stat-value[readonly]:hover {
            background: var(--tg-theme-section-separator-color, #e1e1e1);
            transition: background 0.2s ease;
        }

    /* Стили для броска кубиков */

        .dice-container {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin: 24px 0;
        }

        .dice {
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #f0f0f0, #d0d0d0);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .dice.hope {
            background: linear-gradient(145deg, #4CAF50, #388E3C);
            color: white;
        }

        .dice.fear {
            background: linear-gradient(145deg, #F44336, #D32F2F);
            color: white;
        }

        .dice.rolling {
            animation: roll 0.5s ease-in-out;
        }

        @keyframes roll {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
        }

        .roll-result {
            text-align: center;
            padding: 20px;
            margin: 16px 0;
            border-radius: 12px;
            font-weight: bold;
        }

        .roll-result.success {
            background: #E8F5E8;
            color: #2E7D32;
            border: 2px solid #4CAF50;
        }

        .roll-result.failure {
            background: #FFEBEE;
            color: #C62828;
            border: 2px solid #F44336;
        }

        .roll-result.critical {
            background: #FFF3E0;
            color: #E65100;
            border: 2px solid #FF9800;
        }

    /* Стили для системы правил и гиперссылок */
        .rules-link {
            color: var(--tg-theme-link-color, #0088cc);
            text-decoration: underline;
            cursor: pointer;
            font-style: italic;
        }

        .rules-link:hover {
            opacity: 0.7;
        }

        .ancestry-description {
            line-height: 1.6;
            margin: 16px 0;
        }

        .ancestry-description strong {
            font-weight: bold;
            color: var(--tg-theme-text-color, #000000);
        }

        .ability-title {
            font-weight: bold;
            margin-top: 8px;
            margin-bottom: 4px;
        }

        .rules-content {
            line-height: 1.5;
        }

        .rules-section {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            border-radius: 8px;
        }

        .rules-section h3 {
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
        }

        .breadcrumb {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666666);
            margin-bottom: 16px;
        }

    /* Стили для доменов */
        .class-domains-row {
            display: flex;
            gap: 16px;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .class-group {
            flex: 1;
            margin-bottom: 0;
            margin-top: 0px;
        }

        .domains-group {
            flex-shrink: 0;
            margin-bottom: 0;
        }

        .domains-group .form-label {
            text-align: center;
            width: 100%;
            display: block;
        }

        .domains-container {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 8px;
        }

        .domain-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 6px;
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
            border-radius: 8px;
            min-width: 70px;      
            max-width: 70px;
            width: 70px;
            box-sizing: border-box;
        }

        .domain-icon {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            object-fit: cover;
            border-radius: 8px;
            object-fit: contain;
            background: transparent;
            padding: 4px;
            box-sizing: border-box;
        }

        .domain-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
            text-align: center;
            line-height: 1.2;
            max-width: 80px;      
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

    /* Стили для защиты и уклонения */
        .defense-row-wrapper {
            display: flex;
            justify-content: flex-end;
            margin-top: 0;
            margin-bottom: 8px;
            margin-right: 0;
        }

        .defense-row {
            display: flex;
            gap: 8px;
        }

        .defense-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
            padding: 8px 0;
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            border-radius: 8px;
            min-width: 70px;
        }

        .defense-item .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 2px;
            line-height: 1;
            width: 2.5em;
            text-align: center;
            user-select: none;
            pointer-events: none;
            background: none; 
            border: none; 
            padding: 0;
        }

        .defense-item .stat-label {
            font-size: 12px;
            color: var(--tg-theme-text-color, #000000);
            text-align: center;
            line-height: 1.2;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin: 0;
        }

    /* Стили для гендера */
        .background-gender-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            margin-bottom: 4px;
        }

        .background-gender-row .gender-slot {
             margin-left: 28px;
        }

        .background-group {
            flex: 1;
            min-width: 0;
        }

    /* Стили для шкал */
        .track-fields-row {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
        }

        .track-group {
            flex: 1;
        }

        .track-scale {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-content: center;
            padding: 8px;
            padding-left: 15px; 
            padding-right: 13px;
            background: #f0f0f0;
            border-radius: 8px;
            border: 1px solid #e1e1e1;
            min-height: 50px;
        }

        .track-box {
            width: 15px;
            height: 15px;
            border: 1px solid #333;
            border-radius: 4px;
            flex-shrink: 0;
            display: inline-block;
        }

        .track-box.filled {
            background-color: #0088cc;
        }

        .track-box.empty {
            background-color: #ffffff;
        }

 /*        .track-fields-row .track-group .form-label {
            text-align: center;
        } */

    /* Стили для надежды */
        .hope-defense-container {
            display: flex;
            gap: 18px;
            align-items: center;
            width: 100%;
        }

        .hope-track-group {
            flex: 1;
            margin-right: 0;
            margin-left: 0;
            align-self: center;
            width: auto;
            margin-top: -20px;
        }

        .hope-track-group .form-label {
            font-size: 16px;
            color: var(--tg-theme-text-color, #000000);
            text-align: center;
            margin-bottom: 4px;
        }

        .hope-track {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            justify-content: center;
            align-content: center; 
            padding: 8px;
            background: #f0f0f0;
            border-radius: 8px;
            border: 1px solid #e1e1e1;
            min-height: 50px;
            box-sizing: border-box;
        }

        .hope-track .track-box {
            width: 15px;
            height: 15px;
            border: 1px solid #333;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Главное меню -->
        <div id="main-menu">
            <div class="header">
                <div class="title">⚔️ Daggerheart</div>
                <div class="subtitle">Мобильная ролевая игра</div>
            </div>

            <div class="card">
                <button class="button" onclick="showCharacterCreation()">
                    🎭 Создать персонажа
                </button>
                <button class="button" onclick="showDiceRoll()">
                    🎲 Бросить кубики
                </button>
                <button class="button secondary" onclick="showSession()">
                    📊 Состояние сессии
                </button>
                <button class="button secondary" onclick="showRules()">
                    📚 Правила
                </button>
            </div>
        </div>

        <!-- Создание персонажа -->
        <div id="character-creation" class="hidden">
            <div class="header">
                <div class="title">🎭 Создание персонажа</div>
            </div>

            <div class="card">
                <!-- Карточка персонажа -->
                <div class="character-card">
                    <div class="character-portrait">
                        <img id="char-portrait" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTEwIiBoZWlnaHQ9IjExMCIgdmlld0JveD0iMCAwIDExMCAxMTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMTEiIGhlaWdodD0iMTEwIiByeD0iNTUiIGZpbGw9IiNGNUY1RjUiLz4KPHN2ZyB4PSIzMCIgeT0iMjUiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCI+CiAgPGNpcmNsZSBjeD0iMjUiIGN5PSIyMCIgcj0iMTIiIGZpbGw9IiNERCQiLz4KICA8ZWxsaXBzZSBjeD0iMjUiIGN5PSI0NSIgcng9IjE4IiByeT0iMjAiIGZpbGw9IiNERCQiLz4KPC9zdmc+Cjwvc3ZnPg==" alt="Портрет персонажа">
                    </div>
                    <div class="character-info">
                        <div class="form-group">
                            <label class="form-label">Имя персонажа</label>
                            <input type="text" class="form-input" id="char-name" placeholder="Введите имя" onchange="updatePortrait()">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                Происхождение
                                <button class="info-button" onclick="showBackgroundInfo()" title="Информация о происхождении">?</button>
                            </label>
                            <select class="form-select" id="char-background">
                                <option value="">Выбрать</option>
                                <option value="noble">Великородное</option>
                                <option value="military">Военное</option>
                                <option value="mountain">Горное</option>
                                <option value="dogmatic">Догматичное</option>
                                <option value="lost">Заблудшее</option>
                                <option value="nomadic">Кочевое</option>
                                <option value="criminal">Криминальное</option>
                                <option value="forest">Лесное</option>
                                <option value="frost">Морозное</option>
                                <option value="sea">Морское</option>
                                <option value="scientific">Научное</option>
                                <option value="liberated">Освобождённое</option>
                                <option value="underground">Подземное</option>
                                <option value="desert">Пустынное</option>
                                <option value="rural">Сельское</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="background-gender-row">
                    <div class="form-group background-group">
                        <label class="form-label">
                            Родословная 
                            <button class="info-button" onclick="showAncestryInfo()" title="Информация о родословной">?</button>
                        </label>
                        <select class="form-select" id="char-ancestry" onchange="updatePortrait()">
                            <option value="">Выбрать</option>
                            <option value="akvan">Акван</option>
                            <option value="aeris">Аэрис</option>
                            <option value="giant">Великан</option>
                            <option value="galapa">Галапа</option>
                            <option value="gnome">Гном</option>
                            <option value="goblin">Гоблин</option>
                            <option value="dwarf">Дварф</option>
                            <option value="dragonid">Драконид</option>
                            <option value="ignis">Игнис</option>
                            <option value="infernis">Инфернис</option>
                            <option value="katari">Катари</option>
                            <option value="clank">Кланк</option>
                            <option value="orc">Орк</option>
                            <option value="halfling">Полурослик</option>
                            <option value="ribbet">Риббет</option>
                            <option value="simian">Симиан</option>
                            <option value="terran">Терран</option>
                            <option value="faun">Фавн</option>
                            <option value="fangril">Фангрил</option>
                            <option value="faerie">Фейри</option>
                            <option value="firbolg">Фирболг</option>
                            <option value="human">Человек</option>
                            <option value="elf">Эльф</option>
                            <option value="etheris">Эфирис</option>
                        </select>
                    </div>
                    <div class="gender-slot">
                        <label class="stat-label">Гендер</label>
                        <div class="gender-selector">
                            <label class="radio-option">
                                <input type="radio" name="gender" value="male" checked onchange="updatePortrait()">
                                <span>♂</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="gender" value="female" onchange="updatePortrait()">
                                <span>♀</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="class-domains-row">
                    <div class="form-group class-group">
                        <label class="form-label">
                            Класс
                            <button class="info-button" onclick="showClassInfo()" title="Информация о классе">?</button>
                        </label>
                        <select class="form-select" id="char-class" onchange="updateDomains()">
                            <option value="">Выбрать</option>
                            <option value="bard">Бард</option>
                            <option value="rogue">Плут</option>
                            <option value="sorcerer">Чародей</option>
                            <option value="druid">Друид</option>
                            <option value="ranger">Следопыт</option>
                            <option value="warrior">Воин</option>
                            <option value="guardian">Страж</option>
                            <option value="seraph">Серафим</option>
                            <option value="wizard">Волшебник</option>
                        </select>
                    </div>

                    <div class="form-group domains-group">
                        <label class="form-label">ДОМЕНЫ</label>
                        <div class="domains-container">
                            <div class="domain-slot" id="domain-1">
                                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNiIgZmlsbD0iI0Y1RjVGNSIvPgo8dGV4dCB4PSIxNiIgeT0iMjEiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iI0RERCIgdGV4dC1hbmNоб3I9Im1pZGRsZSI+PzwvdGV4dD4KPC9zdmc+" alt="Домен 1" class="domain-icon">
                                <span class="domain-name">-</span>
                            </div>
                            <div class="domain-slot" id="domain-2">
                                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNiIgZmlsbD0iI0Y1RjVGNSIvPgo8dGV4dCB4PSIxNiIgeT0iMjEiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iI0RERCIgdGV4dC1hbmNоb3I9Im1pZGRsZSI+PzwvdGV4dD4KPC9zdmc+" alt="Домен 2" class="domain-icon">
                                <span class="domain-name">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="defense-row-wrapper">
                    <div class="hope-defense-container">
                        <div class="track-group hope-track-group">
                            <label class="form-label">НАДЕЖДА</label>
                            <div class="track-scale hope-track" id="hope-track">
                                <div class="track-box filled"></div>
                                <div class="track-box filled"></div>
                                <div class="track-box empty"></div>
                                <div class="track-box empty"></div>
                                <div class="track-box empty"></div>
                                <div class="track-box empty"></div>
                            </div>
                        </div>
                        <div class="defense-row">
                            <div class="defense-item">
                                <div class="stat-value" id="evasion" readonly>0</div>
                                <div class="stat-label">Уклонение</div>
                            </div>
                            <div class="defense-item">
                                <div class="stat-value" id="armor" readonly>0</div>
                                <div class="stat-label">Броня</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="track-fields-row">
                    <div class="track-group">
                        <label class="form-label">Жизнь</label>
                        <div class="track-scale" id="life-track">
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                        </div>
                    </div>
                    
                    <div class="track-group">
                        <label class="form-label">Драма</label>
                        <div class="track-scale" id="drama-track">
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Сила</div>
                        <input type="number" class="stat-value" id="strength" value="0" min="-3" max="3" readonly onclick="showStatsMessage()">
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Ловкость</div>
                        <input type="number" class="stat-value" id="agility" value="0" min="-3" max="3" readonly onclick="showStatsMessage()">
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Грация</div>
                        <input type="number" class="stat-value" id="finesse" value="0" min="-3" max="3" readonly onclick="showStatsMessage()">
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Интуиция</div>
                        <input type="number" class="stat-value" id="instinct" value="0" min="-3" max="3" readonly onclick="showStatsMessage()">
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Харизма</div>
                        <input type="number" class="stat-value" id="presence" value="0" min="-3" max="3" readonly onclick="showStatsMessage()">
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Интеллект</div>
                        <input type="number" class="stat-value" id="knowledge" value="0" min="-3" max="3" readonly onclick="showStatsMessage()">
                    </div>
                </div>

                <button class="button" onclick="saveCharacter()">
                    ✅ Сохранить персонажа
                </button>
                <button class="button secondary" onclick="showMainMenu()">
                    ← Назад
                </button>
            </div>
        </div>

        <!-- Бросок кубиков -->
        <div id="dice-roll" class="hidden">
            <div class="header">
                <div class="title">🎲 Бросок кубиков</div>
            </div>

            <div class="card">
                <div class="form-group">
                    <label class="form-label">Тип броска</label>
                    <select class="form-select" id="roll-type">
                        <option value="action">Бросок действия</option>
                        <option value="attack">Бросок атаки</option>
                        <option value="damage">Бросок урона</option>
                        <option value="reaction">Бросок реакции</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Характеристика</label>
                    <select class="form-select" id="trait-modifier">
                        <option value="0">Без модификатора</option>
                        <option value="strength">Сила</option>
                        <option value="agility">Ловкость</option>
                        <option value="finesse">Грация</option>
                        <option value="instinct">Интуиция</option>
                        <option value="presence">Харизма</option>
                        <option value="knowledge">Интеллект</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Сложность</label>
                    <input type="number" class="form-input" id="difficulty" value="12" min="5" max="20">
                </div>

                <div class="dice-container">
                    <div class="dice hope" id="hope-dice">?</div>
                    <div class="dice fear" id="fear-dice">?</div>
                </div>

                <button class="button" onclick="rollDice()" id="roll-button">
                    🎲 Бросить кости дуальности
                </button>

                <div id="roll-result" class="hidden"></div>

                <button class="button secondary" onclick="showMainMenu()">
                    ← Назад
                </button>
            </div>
        </div>

        <div id="session-state" class="hidden">
            <div class="header">
                <div class="title">📊 Состояние сессии</div>
            </div>

            <div class="card">
                <div class="form-group">
                    <label class="form-label">💀 Страх: <span id="session-fear">0</span></label>
                    <label class="form-label">✨ Надежда: <span id="session-hope">0</span></label>
                </div>

                <div class="form-group">
                    <label class="form-label">👤 Мой персонаж</label>
                    <div id="character-info">
                        <p>Персонаж не создан</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">🌍 Текущая сцена</label>
                    <div id="current-scene">
                        <p>Сцена не установлена</p>
                    </div>
                </div>

                <button class="button secondary" onclick="showMainMenu()">← Назад</button>
            </div>
        </div>

        <!-- Добавлен экран правил с глоссарием и навигацией -->
        <div id="rules" class="hidden">
            <div class="header">
                <div class="title">📚 Правила</div>
            </div>

            <div class="card">
                <div class="breadcrumb" id="rules-breadcrumb">Правила</div>
                
                <div id="rules-main">
                    <div class="form-group">
                        <label class="form-label">Разделы правил</label>
                        <button class="button secondary" onclick="showRulesSection('distances')">🎯 Дистанции</button>
                        <button class="button secondary" onclick="showRulesSection('combat')">⚔️ Бой</button>
                        <button class="button secondary" onclick="showRulesSection('glossary')">📖 Глоссарий</button>
                    </div>
                </div>

                <div id="rules-distances" class="hidden">
                    <div class="rules-content">
                        <h3>🎯 Дистанции</h3>
                        <div class="rules-section">
                            <h4>Вплотную</h4>
                            <p>Ваш персонаж находится на расстоянии, позволяющем коснуться цели. Персонаж может коснуться цели, находящийся на расстоянии до метра от него. Имейте в виду, что дистанция Вплотную может быть больше для особо крупных персонажей.</p>
                        </div>
                        <div class="rules-section">
                            <h4>Близко</h4>
                            <p>Короткое расстояние в пределах прямой видимости.</p>
                        </div>
                        <div class="rules-section">
                            <h4>Средне</h4>
                            <p>Ваш персонаж находится достаточно близко к цели, чтобы видеть ее в основных деталях, например, с другого конца комнаты или соседнего рыночного прилавка. Это расстояние составляет примерно от 3 до 9 метров. Находясь в опасности, персонаж может переместиться Вплотную к любой цели, находящейся в пределах Средней дистанции, как часть своего действия.</p>
                        </div>
                        <div class="rules-section">
                            <h4>Далеко</h4>
                            <p>Ваш персонаж находится достаточно далеко, чтобы видеть внешний вид цели, но не детали, например, через небольшое поле боя или в конце большого коридора. Это расстояние составляет примерно от 9 до 30 метров. Пока персонаж находится в опасности, Мастер может попросить его совершить бросок Проворности, чтобы безопасно переместиться Вплотную к любой цели, находящейся в пределах Далекой дистанции.</p>
                        </div>
                    </div>
                </div>

                <div id="rules-combat" class="hidden">
                    <div class="rules-content">
                        <h3>⚔️ Бой</h3>
                        <div class="rules-section">
                            <h4>Раны</h4>
                            <p>Раны представляют физическое здоровье и выносливость персонажа.</p>
                        </div>
                        <div class="rules-section">
                            <h4>Мастерство</h4>
                            <p>Ваше мастерство определяет количество костей урона при успешной атаке.</p>
                        </div>
                        <div class="rules-section">
                            <h4>Один раз за сессию</h4>
                            <p>Некоторые свойства говорят, что вы можете использовать их "один раз за сессию". Эти свойства не обновляются во время отдыха, но вместо этого становятся доступны в начале вашей следующей сессии Daggerheart. Если ваш стол решает играть в одну долгую сессию, Мастер может решить, что все способности "один раз за сессию" обновляются во время перерыва в игре.</p>
                        </div>
                    </div>
                </div>

                <div id="rules-glossary" class="hidden">
                    <div class="rules-content">
                        <h3>📖 Глоссарий</h3>
                        <div class="rules-section">
                            <h4>В</h4>
                            <p><span class="rules-link" onclick="showRulesSection('distances')">Вплотную</span></p>
                        </div>
                        <div class="rules-section">
                            <h4>Д</h4>
                            <p><span class="rules-link" onclick="showRulesSection('distances')">Далеко</span></p>
                        </div>
                        <div class="rules-section">
                            <h4>И</h4>
                            <p><span class="rules-link" onclick="showRulesSection('glossary')">Искусность</span></p>
                        </div>
                        <div class="rules-section">
                            <h4>М</h4>
                            <p><span class="rules-link" onclick="showRulesSection('combat')">Мастерство</span></p>
                        </div>
                        <div class="rules-section">
                            <h4>Н</h4>
                            <p><span class="rules-link" onclick="showRulesSection('glossary')">Надежда</span></p>
                        </div>
                        <div class="rules-section">
                            <h4>О</h4>
                            <p><span class="rules-link" onclick="showRulesSection('combat')">Один раз за сессию</span></p>
                        </div>
                        <div class="rules-section">
                            <h4>Р</h4>
                            <p><span class="rules-link" onclick="showRulesSection('combat')">Рана</span></p>
                        </div>
                        <div class="rules-section">
                            <h4>С</h4>
                            <p><span class="rules-link" onclick="showRulesSection('distances')">Средне</span></p>
                        </div>
                    </div>
                </div>

                <button class="button secondary" onclick="goBackFromRules()">← Назад</button>
            </div>
        </div>

        <!-- Модальное окно для родословных -->
        <div id="ancestry-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="modal-ancestry-title">Информация о родословной</div>
                    <button class="close-button" onclick="closeAncestryModal()">&times;</button>
                </div>
                <div id="modal-ancestry-description">
                    Выберите родословную для просмотра информации.
                </div>
            </div>
        </div>

        <!-- Модальное окно для классов -->
        <div id="class-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="modal-class-title">Информация о классе</div>
                    <button class="close-button" onclick="closeClassModal()">&times;</button>
                </div>
                <div id="modal-class-description">
                    Выберите класс для просмотра информации.
                </div>
            </div>
        </div>

        <!-- Модальное окно для происхождений -->
        <div id="background-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="modal-background-title">Информация о происхождении</div>
                    <button class="close-button" onclick="closeBackgroundModal()">&times;</button>
                </div>
                <div id="modal-background-description">
                    Выберите происхождение для просмотра информации.
                </div>
            </div>
        </div>

        <!-- Модальное окно уведомления о характеристиках -->
        <div id="stats-notification-modal" class="notification-modal">
            <div class="notification-content">
                <div class="notification-title">
                    🎯 Рекомендуемые характеристики
                </div>
                <div class="notification-text">
                    Используются рекомендуемые характеристики для выбранного класса.<br><br>
                    Возможность изменения характеристик будет доступна за пончики <span class="donut-icon">🍩</span> в будущих обновлениях!
                </div>
                <div class="notification-buttons">
                    <button class="notification-button primary" onclick="closeStatsNotification()">
                        Понятно
                    </button>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        // Глобальные переменные
        var currentCharacter = null;
        var sessionData = {
            fear: 0,
            hope: 0,
            scene: '',
            players: []
        };

        // Данные о родословных (заглушки для описаний)
        var ancestryData = {
            akvan: { 
                name: "Акван", 
                description: `<p><em>Акваны происходят от водных элементалей. Это гуманоиды, чьи тела состоят из плоти и воды.</em></p>
                
                <div class="ability-title"><strong>Источник Жизни:</strong></div>
                <p><span class="rules-link" onclick="openRulesLink('combat', 'once-per-session')">Один раз за сессию</span> вы можете использовать немного воды из окрестностей, чтобы исцелить союзника, находящегося <span class="rules-link" onclick="openRulesLink('distances', 'vplotnoyu')">Вплотную</span>. Когда вы это делаете, снимите 1 <span class="rules-link" onclick="openRulesLink('combat', 'wounds')">Рану</span> у цели.</p>
                
                <div class="ability-title"><strong>Водный Кнут:</strong></div>
                <p>Вы можете вытягивать воду из окружающей среды, чтобы использовать ее для атаки. Сделав это, считайте её как оружие <span class="rules-link" onclick="openRulesLink('glossary', 'iskusnost')">Искусности</span> со <span class="rules-link" onclick="openRulesLink('distances', 'sredne')">Средней</span> дистанцией, наносящее d6 магического урона, используя <span class="rules-link" onclick="openRulesLink('combat', 'masterstvo')">Мастерство</span>. Если вы находитесь в пределах <em>Близкой</em> дистанции от водоема, вы можете потратить <span class="rules-link" onclick="openRulesLink('glossary', 'nadezhda')">Надежду</span>, чтобы увеличить дистанцию атаки до <span class="rules-link" onclick="openRulesLink('distances', 'daleko')">Далёкой</span> и нанести d10 урона вместо этого.</p>`
            },
            aeris: { 
                name: "Аэрис", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_АЭРИС - Замените это описание на реальное из правил Daggerheart" 
            },
            giant: { 
                name: "Великан", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ВЕЛИКАН - Замените это описание на реальное из правил Daggerheart" 
            },
            galapa: { 
                name: "Галапа", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ГАЛАПА - Замените это описание на реальное из правил Daggerheart" 
            },
            gnome: { 
                name: "Гном", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ГНОМ - Замените это описание на реальное из правил Daggerheart" 
            },
            goblin: { 
                name: "Гоблин", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ГОБЛИН - Замените это описание на реальное из правил Daggerheart" 
            },
            dwarf: { 
                name: "Дварф", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ДВАРФ - Замените это описание на реальное из правил Daggerheart" 
            },
            dragonid: { 
                name: "Драконид", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ДРАКОНИД - Замените это описание на реальное из правил Daggerheart" 
            },
            ignis: { 
                name: "Игнис", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ИГНИС - Замените это описание на реальное из правил Daggerheart" 
            },
            infernis: { 
                name: "Инфернис", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ИНФЕРНИС - Замените это описание на реальное из правил Daggerheart" 
            },
            katari: { 
                name: "Катари", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_КАТАРИ - Замените это описание на реальное из правил Daggerheart" 
            },
            clank: { 
                name: "Кланк", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_КЛАНК - Замените это описание на реальное из правил Daggerheart" 
            },
            orc: { 
                name: "Орк", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ОРК - Замените это описание на реальное из правил Daggerheart" 
            },
            halfling: { 
                name: "Полурослик", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ПОЛУРОСЛИК - Замените это описание на реальное из правил Daggerheart" 
            },
            ribbet: { 
                name: "Риббет", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_РИББЕТ - Замените это описание на реальное из правил Daggerheart" 
            },
            simian: { 
                name: "Симиан", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_СИМИАН - Замените это описание на реальное из правил Daggerheart" 
            },
            terran: { 
                name: "Терран", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ТЕРРАН - Замените это описание на реальное из правил Daggerheart" 
            },
            faun: { 
                name: "Фавн", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ФАВН - Замените это описание на реальное из правил Daggerheart" 
            },
            fangril: { 
                name: "Фангрил", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ФАНГРИЛ - Замените это описание на реальное из правил Daggerheart" 
            },
            faerie: { 
                name: "Фейри", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ФЕЙРИ - Замените это описание на реальное из правил Daggerheart" 
            },
            firbolg: { 
                name: "Фирболг", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ФИРБОЛГ - Замените это описание на реальное из правил Daggerheart" 
            },
            human: { 
                name: "Человек", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ЧЕЛОВЕК - Замените это описание на реальное из правил Daggerheart" 
            },
            elf: { 
                name: "Эльф", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ЭЛЬФ - Замените это описание на реальное из правил Daggerheart" 
            },
            etheris: { 
                name: "Эфирис", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ЭФИРИС - Замените это описание на реальное из правил Daggerheart" 
            }
        };

        // Данные о классах
        var classData = {
            bard: { 
                name: "Бард", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_БАРД - Замените это описание на реальное из правил Daggerheart",
                domains: ["codex", "grace"],
                stats: { agility: 0, strength: -1, finesse: +1, instinct: 0, presence: +2, knowledge: +1 },
                evasion: 10
            },
            rogue: { 
                name: "Плут", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ПЛУТ - Замените это описание на реальное из правил Daggerheart",
                domains: ["grace", "midnight"], 
                stats: { strength: -1, agility: +1, finesse: +2, instinct: +1, presence: 0, knowledge: 0 },
                evasion: 12
            },
            sorcerer: { 
                name: "Чародей", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ЧАРОДЕЙ - Замените это описание на реальное из правил Daggerheart",
                domains: ["midnight", "arcana"], 
                stats: { strength: -1, agility: 0, finesse: +1, instinct: +2, presence: +1, knowledge: +0 },
                evasion: 10
            },
            druid: { 
                name: "Друид", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ДРУИД - Замените это описание на реальное из правил Daggerheart",
                domains: ["arcana", "sage"], 
                stats: { strength: 0, agility: +1, finesse: +1, instinct: +2, presence: -1, knowledge: 0 },
                evasion: 10
            },
            ranger: { 
                name: "Следопыт", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_СЛЕДОПЫТ - Замените это описание на реальное из правил Daggerheart",
                domains: ["sage", "bone"], 
                stats: { strength: 0, agility: +2, finesse: +1, instinct: +1, presence: -1, knowledge: 0 },
                evasion: 12
            },
            warrior: { 
                name: "Воин", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ВОИН - Замените это описание на реальное из правил Daggerheart",
                domains: ["bone", "blade"], 
                stats: { strength: +1, agility: +2, finesse: 0, instinct: +1, presence: -1, knowledge: 0 },
                evasion: 11
            },
            guardian: { 
                name: "Страж", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_СТРАЖ - Замените это описание на реальное из правил Daggerheart",
                domains: ["blade", "valor"], 
                stats: { strength: +2, agility: +1, finesse: -1, instinct: 0, presence: +1, knowledge: 0 },
                evasion: 9
            },
            seraph: { 
                name: "Серафим", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_СЕРАФИМ - Замените это описание на реальное из правил Daggerheart",
                domains: ["valor", "splendor"], 
                stats: { strength: +2, agility: 0, finesse: 0, instinct: +1, presence: +1, knowledge: -1 },
                evasion: 9
            },
            wizard: { 
                name: "Волшебник", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ВОЛШЕБНИК - Замените это описание на реальное из правил Daggerheart",
                domains: ["splendor", "codex"], 
                stats: { strength: 0, agility: -1, finesse: 0, instinct: +1, presence: +1, knowledge: +2 },
                evasion: 11
            }
        };

        // Данные о происхождениях
        var backgroundData = {
            noble: { 
                name: "Великородное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ВЕЛИКОРОДНОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж происходит из знатной семьи." 
            },
            military: { 
                name: "Военное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ВОЕННОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж имеет военное прошлое." 
            },
            mountain: { 
                name: "Горное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ГОРНОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж вырос в горах." 
            },
            dogmatic: { 
                name: "Догматичное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ДОГМАТИЧНОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж следует строгим убеждениям." 
            },
            lost: { 
                name: "Заблудшее", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ЗАБЛУДШЕЕ - Замените это описание на реальное из правил Daggerheart. Персонаж потерял свой путь." 
            },
            nomadic: { 
                name: "Кочевое", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_КОЧЕВОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж всегда в движении." 
            },
            criminal: { 
                name: "Криминальное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_КРИМИНАЛЬНОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж связан с преступным миром." 
            },
            forest: { 
                name: "Лесное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ЛЕСНОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж вырос среди деревьев." 
            },
            frost: { 
                name: "Морозное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_МОРОЗНОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж закален холодом." 
            },
            sea: { 
                name: "Морское", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_МОРСКОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж связан с морем." 
            },
            scientific: { 
                name: "Научное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_НАУЧНОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж стремится к знаниям." 
            },
            liberated: { 
                name: "Освобождённое", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ОСВОБОЖДЁННОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж обрел свободу." 
            },
            underground: { 
                name: "Подземное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ПОДЗЕМНОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж вырос под землей." 
            },
            desert: { 
                name: "Пустынное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ПУСТЫННОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж закален пустыней." 
            },
            rural: { 
                name: "Сельское", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_СЕЛЬСКОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж вырос в деревне." 
            }
        };

        // Данные о доменах
        var domainData = {
            codex:    { name: "Кодекс",    icon: "images/domaines/codex.svg" },
            grace:    { name: "Грация",    icon: "images/domaines/grace.svg" },
            midnight: { name: "Полночь",   icon: "images/domaines/midnight.svg" },
            arcana:   { name: "Аркана",    icon: "images/domaines/arcana.svg" },
            sage:     { name: "Мудрость",  icon: "images/domaines/sage.svg" },
            bone:     { name: "Кость",     icon: "images/domaines/bone.svg" },
            blade:    { name: "Клинок",    icon: "images/domaines/blade.svg" },
            valor:    { name: "Доблесть",  icon: "images/domaines/valor.svg" },
            splendor: { name: "Величие",   icon: "images/domaines/splendor.svg" }
        };
        
        var rulesFromScreen = 'main-menu';

        // Функции навигации
        function showMainMenu() {
            hideAllScreens();
            document.getElementById('main-menu').classList.remove('hidden');
        }

        function showCharacterCreation() {
            hideAllScreens();
            document.getElementById('character-creation').classList.remove('hidden');
            
            // Сброс всех полей формы
            document.getElementById('char-name').value = '';
            document.getElementById('char-ancestry').value = '';
            document.getElementById('char-background').value = '';
            document.getElementById('char-class').value = '';
            
            // Сброс радиокнопок гендера на мужской по умолчанию
            var genderRadios = document.getElementsByName('gender');
            for (var i = 0; i < genderRadios.length; i++) {
                if (genderRadios[i].value === 'male') {
                    genderRadios[i].checked = true;
                } else {
                    genderRadios[i].checked = false;
                }
            }
            
            // Сброс характеристик на 0
            document.getElementById('strength').value = 0;
            document.getElementById('agility').value = 0;
            document.getElementById('finesse').value = 0;
            document.getElementById('instinct').value = 0;
            document.getElementById('presence').value = 0;
            document.getElementById('knowledge').value = 0;
            
            // Сброс доменов на заглушки
            var domain1Slot = document.getElementById('domain-1');
            var domain2Slot = document.getElementById('domain-2');
            domain1Slot.querySelector('.domain-icon').src = "images/domaines/domain-placeholder.svg";
            domain1Slot.querySelector('.domain-name').textContent = "-";
            domain2Slot.querySelector('.domain-icon').src = "images/domaines/domain-placeholder.svg";
            domain2Slot.querySelector('.domain-name').textContent = "-";
            
            // Сброс портрета на заглушку
            document.getElementById('char-portrait').src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTEwIiBoZWlnaHQ9IjExMCIgdmlld0JveD0iMCAwIDExMCAxMTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMTEiIGhlaWdodD0iMTEwIiByeD0iNTUiIGZpbGw9IiNGNUY1RjUiLz4KPHN2ZyB4PSIzMCIgeT0iMjUiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCI+CiAgPGNpcmNsZSBjeD0iMjUiIGN5PSIyMCIgcj0iMTIiIGZpbGw9IiNERCQiLz4KICA8ZWxsaXBzZSBjeD0iMjUiIGN5PSI0NSIgcng9IjE4IiByeT0iMjAiIGZpbGw9IiNERCQiLz4KPC9zdmc+Cjwvc3ZnPg==";
        }

        function showDiceRoll() {
            hideAllScreens();
            document.getElementById('dice-roll').classList.remove('hidden');
        }

        function showSession() {
            hideAllScreens();
            document.getElementById('session-state').classList.remove('hidden');
            loadSessionData();
        }

        function showRules() {
            rulesFromScreen = getCurrentScreen();
            hideAllScreens();
            document.getElementById('rules').classList.remove('hidden');
            showRulesMain();
        }

        function showRulesMain() {
            hideAllRulesSections();
            document.getElementById('rules-main').classList.remove('hidden');
            document.getElementById('rules-breadcrumb').textContent = 'Правила';
        }

        function showRulesSection(section) {
            hideAllRulesSections();
            document.getElementById('rules-' + section).classList.remove('hidden');
            
            var sectionNames = {
                'distances': 'Правила > Дистанции',
                'combat': 'Правила > Бой', 
                'glossary': 'Правила > Глоссарий'
            };
            document.getElementById('rules-breadcrumb').textContent = sectionNames[section] || 'Правила';
        }

        function hideAllRulesSections() {
            var sections = ['rules-main', 'rules-distances', 'rules-combat', 'rules-glossary'];
            for (var i = 0; i < sections.length; i++) {
                document.getElementById(sections[i]).classList.add('hidden');
            }
        }

        function openRulesLink(section, anchor) {
            rulesFromScreen = getCurrentScreen();
            hideAllScreens();
            document.getElementById('rules').classList.remove('hidden');
            showRulesSection(section);
        }

        function goBackFromRules() {
            hideAllScreens();
            if (rulesFromScreen === 'character-creation') {
                document.getElementById('character-creation').classList.remove('hidden');
            } else if (rulesFromScreen === 'dice-roll') {
                document.getElementById('dice-roll').classList.remove('hidden');
            } else if (rulesFromScreen === 'session-state') {
                document.getElementById('session-state').classList.remove('hidden');
                loadSessionData();
            } else {
                document.getElementById('main-menu').classList.remove('hidden');
            }
        }

        function getCurrentScreen() {
            var screens = ['main-menu', 'character-creation', 'dice-roll', 'session-state'];
            for (var i = 0; i < screens.length; i++) {
                if (!document.getElementById(screens[i]).classList.contains('hidden')) {
                    return screens[i];
                }
            }
            return 'main-menu';
        }

        function hideAllScreens() {
            var screens = ['main-menu', 'character-creation', 'dice-roll', 'session-state', 'rules'];
            for (var i = 0; i < screens.length; i++) {
                document.getElementById(screens[i]).classList.add('hidden');
            }
        }

        // Функции персонажа
        function updatePortrait() {
            var ancestry = document.getElementById('char-ancestry').value;
            var genderRadios = document.getElementsByName('gender');
            var gender = 'male';

            for (var i = 0; i < genderRadios.length; i++) {
                if (genderRadios[i].checked) {
                    gender = genderRadios[i].value;
                    break;
                }
            }

            var portraitImg = document.getElementById('char-portrait');

            if (!ancestry || ancestry === "") {
                // Показываем портрет-заглушку
                portraitImg.src = "images/portraits/placeholder.png";
            } else if (ancestry && portraitImg) {
                var portraitPath = './images/portraits/' + ancestry + '_' + gender + '.png';
                portraitImg.src = portraitPath;
            }
        }

        function updateDomains() {
            var classValue = document.getElementById('char-class').value;
            var domain1Slot = document.getElementById('domain-1');
            var domain2Slot = document.getElementById('domain-2');

            if (classValue && classData[classValue]) {
                var domains = classData[classValue].domains;
                var stats = classData[classValue].stats;
                var evasion = classData[classValue].evasion;
                
                // Обновляем первый домен
                var domain1Data = domainData[domains[0]];
                if (domain1Data) {
                    domain1Slot.querySelector('.domain-icon').src = domain1Data.icon;
                    domain1Slot.querySelector('.domain-name').textContent = domain1Data.name;
                }

                // Обновляем второй домен
                var domain2Data = domainData[domains[1]];
                if (domain2Data) {
                    domain2Slot.querySelector('.domain-icon').src = domain2Data.icon;
                    domain2Slot.querySelector('.domain-name').textContent = domain2Data.name;
                }

                // Обновляем характеристики
                if (stats) {
                    document.getElementById('strength').value = stats.strength;
                    document.getElementById('agility').value = stats.agility;
                    document.getElementById('finesse').value = stats.finesse;
                    document.getElementById('instinct').value = stats.instinct;
                    document.getElementById('presence').value = stats.presence;
                    document.getElementById('knowledge').value = stats.knowledge;
                }

                // Обновляем уклонение
                if (evasion !== undefined) {
                    document.getElementById('evasion').textContent = evasion;
                }
            } else {
                // Сбрасываем домены на заглушки
                domain1Slot.querySelector('.domain-icon').src = "images/domaines/domain-placeholder.svg";
                domain1Slot.querySelector('.domain-name').textContent = "-";

                domain2Slot.querySelector('.domain-icon').src = "images/domaines/domain-placeholder.svg";
                domain2Slot.querySelector('.domain-name').textContent = "-";

                // Сбрасываем характеристики на 0
                document.getElementById('strength').value = 0;
                document.getElementById('agility').value = 0;
                document.getElementById('finesse').value = 0;
                document.getElementById('instinct').value = 0;
                document.getElementById('presence').value = 0;
                document.getElementById('knowledge').value = 0;

                // Сбрасываем уклонение на 0
                document.getElementById('evasion').textContent = 0;
            }
        }

        function saveCharacter() {
            var name = document.getElementById('char-name').value;
            var ancestry = document.getElementById('char-ancestry').value;
            var charClass = document.getElementById('char-class').value;

            if (!name || !ancestry || !charClass) {
                alert('Пожалуйста, заполните все обязательные поля!');
                return;
            }

            alert('Персонаж создан успешно!');
            
            // Сохраняем в локальное хранилище
            if (typeof(Storage) !== "undefined") {
                localStorage.setItem('daggerheart_character', JSON.stringify({
                    name: name,
                    ancestry: ancestry,
                    gender: gender,
                    class: charClass,
                    hit_points: 20,
                    max_hit_points: 20,
                    stress: 0
                }));
            }
            
            showMainMenu();
        }

        // Модальные окна
        function showClassInfo() {
            var classValue = document.getElementById('char-class').value;
            var modal = document.getElementById('class-modal');
            var title = document.getElementById('modal-class-title');
            var description = document.getElementById('modal-class-description');

            if (classValue && classData[classValue]) {
                title.textContent = classData[classValue].name;
                if (classData[classValue].description.includes('<')) {
                    description.innerHTML = classData[classValue].description;
                } else {
                    description.textContent = classData[classValue].description;
                }
            } else {
                title.textContent = "Информация о классе";
                description.textContent = "Сначала выберите класс из списка.";
            }

            modal.style.display = 'block';
        }

        function closeClassModal() {
            document.getElementById('class-modal').style.display = 'none';
        }

        function showAncestryInfo() {
            var ancestry = document.getElementById('char-ancestry').value;
            var modal = document.getElementById('ancestry-modal');
            var title = document.getElementById('modal-ancestry-title');
            var description = document.getElementById('modal-ancestry-description');

            if (ancestry && ancestryData[ancestry]) {
                title.textContent = ancestryData[ancestry].name;
                if (ancestryData[ancestry].description.includes('<')) {
                    description.innerHTML = ancestryData[ancestry].description;
                } else {
                    description.textContent = ancestryData[ancestry].description;
                }
            } else {
                title.textContent = "Информация о родословной";
                description.textContent = "Сначала выберите родословную из списка.";
            }

            modal.style.display = 'block';
        }

        function closeAncestryModal() {
            document.getElementById('ancestry-modal').style.display = 'none';
        }

        function showBackgroundInfo() {
            var backgroundValue = document.getElementById('char-background').value;
            var modal = document.getElementById('background-modal');
            var title = document.getElementById('modal-background-title');
            var description = document.getElementById('modal-background-description');

            if (backgroundValue && backgroundData[backgroundValue]) {
                title.textContent = backgroundData[backgroundValue].name;
                if (backgroundData[backgroundValue].description.includes('<')) {
                    description.innerHTML = backgroundData[backgroundValue].description;
                } else {
                    description.textContent = backgroundData[backgroundValue].description;
                }
            } else {
                title.textContent = "Информация о происхождении";
                description.textContent = "Сначала выберите происхождение из списка.";
            }

            modal.style.display = 'block';
        }

        function closeBackgroundModal() {
            document.getElementById('background-modal').style.display = 'none';
        }

    // Система модальных пончиков

        // Функция показа уведомления о характеристиках
        function showStatsMessage() {
            var classValue = document.getElementById('char-class').value;
            
            // Показываем уведомление только если выбран класс
            if (classValue && classData[classValue]) {
                document.getElementById('stats-notification-modal').style.display = 'block';
            }
        }

        // Функция закрытия уведомления
        function closeStatsNotification() {
            document.getElementById('stats-notification-modal').style.display = 'none';
        }

        // Закрытие уведомления по клику вне окна
        window.onclick = function(event) {
            var modal = document.getElementById('stats-notification-modal');
            if (event.target == modal) {
                closeStatsNotification();
            }
            
            // Сохраняем существующие обработчики для других модальных окон
            var ancestryModal = document.getElementById('ancestry-modal');
            if (event.target == ancestryModal) {
                closeAncestryModal();
            }
            
            var classModal = document.getElementById('class-modal');
            if (event.target == classModal) {
                closeClassModal();
            }
            
            var backgroundModal = document.getElementById('background-modal');
            if (event.target == backgroundModal) {
                closeBackgroundModal();
            }
        }

        // Система бросков кубиков
        function rollDice() {
            var rollButton = document.getElementById('roll-button');
            var hopeDice = document.getElementById('hope-dice');
            var fearDice = document.getElementById('fear-dice');
            var resultDiv = document.getElementById('roll-result');

            rollButton.disabled = true;
            hopeDice.classList.add('rolling');
            fearDice.classList.add('rolling');

            var rollCount = 0;
            var rollInterval = setInterval(function() {
                hopeDice.textContent = Math.floor(Math.random() * 12) + 1;
                fearDice.textContent = Math.floor(Math.random() * 12) + 1;
                rollCount++;

                if (rollCount >= 10) {
                    clearInterval(rollInterval);
                    finishRoll();
                }
            }, 50);
        }

        function finishRoll() {
            var hopeDice = document.getElementById('hope-dice');
            var fearDice = document.getElementById('fear-dice');
            var resultDiv = document.getElementById('roll-result');
            var rollButton = document.getElementById('roll-button');

            var hopeRoll = Math.floor(Math.random() * 12) + 1;
            var fearRoll = Math.floor(Math.random() * 12) + 1;

            hopeDice.textContent = hopeRoll;
            fearDice.textContent = fearRoll;

            hopeDice.classList.remove('rolling');
            fearDice.classList.remove('rolling');

            var difficulty = parseInt(document.getElementById('difficulty').value);
            var traitMod = getTraitModifier();
            var total = Math.max(hopeRoll, fearRoll) + traitMod;

            var resultText = '';
            var resultClass = '';

            if (hopeRoll === fearRoll) {
                resultText = '🌟 КРИТИЧЕСКИЙ УСПЕХ! (' + hopeRoll + '/' + fearRoll + ' + ' + traitMod + ' = ' + total + ')';
                resultClass = 'critical';
            } else if (total >= difficulty) {
                if (hopeRoll > fearRoll) {
                    resultText = '✅ Успех с Надеждой! (' + total + ' ≥ ' + difficulty + ')';
                    resultClass = 'success';
                } else {
                    resultText = '✅ Успех со Страхом (' + total + ' ≥ ' + difficulty + ')';
                    resultClass = 'success';
                }
            } else {
                resultText = '❌ Неудача (' + total + ' < ' + difficulty + ')';
                resultClass = 'failure';
            }

            resultDiv.innerHTML = resultText;
            resultDiv.className = 'roll-result ' + resultClass;
            resultDiv.classList.remove('hidden');

            rollButton.disabled = false;
        }

        function getTraitModifier() {
            var traitSelect = document.getElementById('trait-modifier');
            var selectedTrait = traitSelect.value;

            if (selectedTrait === '0') {
                return 0;
            }

            return Math.floor(Math.random() * 6) - 2;
        }

        // Функции состояния сессии
        function loadSessionData() {
            if (typeof(Storage) !== "undefined") {
                var savedCharacter = localStorage.getItem('daggerheart_character');
                if (savedCharacter) {
                    currentCharacter = JSON.parse(savedCharacter);
                }
            }
            updateSessionDisplay();
        }

        function updateSessionDisplay() {
            document.getElementById('session-fear').textContent = sessionData.fear;
            document.getElementById('session-hope').textContent = sessionData.hope;

            var characterInfo = document.getElementById('character-info');
            if (currentCharacter) {
                characterInfo.innerHTML = '<strong>' + currentCharacter.name + '</strong><br>' +
                    currentCharacter.ancestry + ' ' + currentCharacter.class + '<br>' +
                    '💖 ' + currentCharacter.hit_points + '/' + currentCharacter.max_hit_points + ' HP<br>' +
                    '😰 ' + currentCharacter.stress + ' Стресс';
            } else {
                characterInfo.innerHTML = '<p>Персонаж не создан</p>';
            }

            var sceneInfo = document.getElementById('current-scene');
            if (sessionData.scene) {
                sceneInfo.innerHTML = '<p>' + sessionData.scene + '</p>';
            } else {
                sceneInfo.innerHTML = '<p>Сцена не установлена</p>';
            }
        }

        // Инициализация
        window.addEventListener('load', function() {
            console.log('Приложение загружено');
        });
    </script>
</body>
</html>