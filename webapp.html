<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daggerheart</title>
    <script src="https://telegram.org/js/telegram-web-app.js?57"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #0088cc);
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--tg-theme-hint-color, #666666);
            font-size: 14px;
        }

        .card {
            background: var(--tg-theme-secondary-bg-color, #f7f7f7);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
        }

        .button {
            display: block;
            width: 100%;
            padding: 12px 16px;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 12px;
            transition: opacity 0.2s;
        }

        .button:hover {
            opacity: 0.8;
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button.secondary {
            background: var(--tg-theme-secondary-bg-color, #f7f7f7);
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
        }

        .dice-container {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin: 24px 0;
        }

        .dice {
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #f0f0f0, #d0d0d0);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .dice.hope {
            background: linear-gradient(145deg, #4CAF50, #388E3C);
            color: white;
        }

        .dice.fear {
            background: linear-gradient(145deg, #F44336, #D32F2F);
            color: white;
        }

        .dice.rolling {
            animation: roll 0.5s ease-in-out;
        }

        @keyframes roll {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
        }

        .character-form {
            display: none;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
            border-radius: 8px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            border-radius: 8px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666666);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--tg-theme-text-color, #000000);
        }

        .resources {
            display: flex;
            gap: 16px;
            margin: 16px 0;
        }

        .resource {
            flex: 1;
            text-align: center;
            padding: 12px;
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            border-radius: 8px;
        }

        .resource.fear {
            border: 2px solid #F44336;
        }

        .resource.hope {
            border: 2px solid #4CAF50;
        }

        .hidden {
            display: none !important;
        }

        .roll-result {
            text-align: center;
            padding: 20px;
            margin: 16px 0;
            border-radius: 12px;
            font-weight: bold;
        }

        .roll-result.success {
            background: #E8F5E8;
            color: #2E7D32;
            border: 2px solid #4CAF50;
        }

        .roll-result.failure {
            background: #FFEBEE;
            color: #C62828;
            border: 2px solid #F44336;
        }

        .roll-result.critical {
            background: #FFF3E0;
            color: #E65100;
            border: 2px solid #FF9800;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
        <div id="main-menu">
            <div class="header">
                <div class="title">‚öîÔ∏è Daggerheart</div>
                <div class="subtitle">–ù–∞—Å—Ç–æ–ª—å–Ω–∞—è —Ä–æ–ª–µ–≤–∞—è –∏–≥—Ä–∞</div>
            </div>

            <div class="card">
                <button class="button" onclick="showCharacterCreation()">
                    üé≠ –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
                </button>
                <button class="button" onclick="showDiceRoll()">
                    üé≤ –ë—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫–∏
                </button>
                <button class="button secondary" onclick="showSession()">
                    üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏
                </button>
            </div>
        </div>

        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ -->
        <div id="character-creation" class="character-form">
            <div class="header">
                <div class="title">üé≠ –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</div>
            </div>

            <div class="card">
                <div class="form-group">
                    <label class="form-label">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</label>
                    <input type="text" class="form-input" id="char-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                </div>

                <div class="form-group">
                    <label class="form-label">–†–æ–¥–æ—Å–ª–æ–≤–Ω–∞—è</label>
                    <select class="form-select" id="char-ancestry">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–¥–æ—Å–ª–æ–≤–Ω—É—é</option>
                        <option value="human">–ß–µ–ª–æ–≤–µ–∫</option>
                        <option value="elf">–≠–ª—å—Ñ</option>
                        <option value="dwarf">–î–≤–∞—Ä—Ñ</option>
                        <option value="halfling">–ü–æ–ª—É—Ä–æ—Å–ª–∏–∫</option>
                        <option value="orc">–û—Ä–∫</option>
                        <option value="faerie">–§–µ—è</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">–ö–ª–∞—Å—Å</label>
                    <select class="form-select" id="char-class">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>
                        <option value="guardian">–°—Ç—Ä–∞–∂</option>
                        <option value="warrior">–í–æ–∏–Ω</option>
                        <option value="rogue">–ü–ª—É—Ç</option>
                        <option value="ranger">–°–ª–µ–¥–æ–ø—ã—Ç</option>
                        <option value="wizard">–í–æ–ª—à–µ–±–Ω–∏–∫</option>
                        <option value="sorcerer">–ß–∞—Ä–æ–¥–µ–π</option>
                    </select>
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">–°–∏–ª–∞</div>
                        <input type="number" class="stat-value" id="strength" value="0" min="-3" max="3">
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">–ü—Ä–æ–≤–æ—Ä–Ω–æ—Å—Ç—å</div>
                        <input type="number" class="stat-value" id="agility" value="0" min="-3" max="3">
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">–ò—Å–∫—É—Å–Ω–æ—Å—Ç—å</div>
                        <input type="number" class="stat-value" id="finesse" value="0" min="-3" max="3">
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">–ò–Ω—Å—Ç–∏–Ω–∫—Ç</div>
                        <input type="number" class="stat-value" id="instinct" value="0" min="-3" max="3">
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">–í–ª–∏—è–Ω–∏–µ</div>
                        <input type="number" class="stat-value" id="presence" value="0" min="-3" max="3">
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">–ó–Ω–∞–Ω–∏–µ</div>
                        <input type="number" class="stat-value" id="knowledge" value="0" min="-3" max="3">
                    </div>
                </div>

                <button class="button" onclick="saveCharacter()">
                    ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
                </button>
                <button class="button secondary" onclick="showMainMenu()">
                    ‚Üê –ù–∞–∑–∞–¥
                </button>
            </div>
        </div>

        <!-- –ë—Ä–æ—Å–æ–∫ –∫—É–±–∏–∫–æ–≤ -->
        <div id="dice-roll" class="hidden">
            <div class="header">
                <div class="title">üé≤ –ë—Ä–æ—Å–æ–∫ –∫—É–±–∏–∫–æ–≤</div>
            </div>

            <div class="card">
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø –±—Ä–æ—Å–∫–∞</label>
                    <select class="form-select" id="roll-type">
                        <option value="action">–ë—Ä–æ—Å–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</option>
                        <option value="attack">–ë—Ä–æ—Å–æ–∫ –∞—Ç–∞–∫–∏</option>
                        <option value="damage">–ë—Ä–æ—Å–æ–∫ —É—Ä–æ–Ω–∞</option>
                        <option value="reaction">–ë—Ä–æ—Å–æ–∫ —Ä–µ–∞–∫—Ü–∏–∏</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞</label>
                    <select class="form-select" id="trait-modifier">
                        <option value="0">–ë–µ–∑ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞</option>
                        <option value="strength">–°–∏–ª–∞</option>
                        <option value="agility">–ü—Ä–æ–≤–æ—Ä–Ω–æ—Å—Ç—å</option>
                        <option value="finesse">–ò—Å–∫—É—Å–Ω–æ—Å—Ç—å</option>
                        <option value="instinct">–ò–Ω—Å—Ç–∏–Ω–∫—Ç</option>
                        <option value="presence">–í–ª–∏—è–Ω–∏–µ</option>
                        <option value="knowledge">–ó–Ω–∞–Ω–∏–µ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                    <input type="number" class="form-input" id="difficulty" value="12" min="5" max="20">
                </div>

                <div class="dice-container">
                    <div class="dice hope" id="hope-dice">?</div>
                    <div class="dice fear" id="fear-dice">?</div>
                </div>

                <button class="button" onclick="rollDice()" id="roll-button">
                    üé≤ –ë—Ä–æ—Å–∏—Ç—å –∫–æ—Å—Ç–∏ –¥—É–∞–ª—å–Ω–æ—Å—Ç–∏
                </button>

                <div id="roll-result" class="hidden"></div>

                <button class="button secondary" onclick="showMainMenu()">
                    ‚Üê –ù–∞–∑–∞–¥
                </button>
            </div>
        </div>

        <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏ -->
        <div id="session-state" class="hidden">
            <div class="header">
                <div class="title">üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏</div>
            </div>

            <div class="resources">
                <div class="resource fear">
                    <div class="stat-label">üíÄ –°—Ç—Ä–∞—Ö</div>
                    <div class="stat-value" id="session-fear">0</div>
                </div>
                <div class="resource hope">
                    <div class="stat-label">‚ú® –ù–∞–¥–µ–∂–¥–∞</div>
                    <div class="stat-value" id="session-hope">0</div>
                </div>
            </div>

            <div class="card">
                <div class="form-label">üë§ –ú–æ–π –ø–µ—Ä—Å–æ–Ω–∞–∂</div>
                <div id="character-info">
                    <p>–ü–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ —Å–æ–∑–¥–∞–Ω</p>
                </div>
            </div>

            <div class="card">
                <div class="form-label">üåç –¢–µ–∫—É—â–∞—è —Å—Ü–µ–Ω–∞</div>
                <div id="current-scene">
                    <p>–°—Ü–µ–Ω–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</p>
                </div>
            </div>

            <button class="button secondary" onclick="showMainMenu()">
                ‚Üê –ù–∞–∑–∞–¥
            </button>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
        document.documentElement.style.setProperty('--tg-color-scheme', tg.colorScheme);

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentCharacter = null;
        let sessionData = {
            fear: 0,
            hope: 0,
            scene: '',
            players: []
        };

        // –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        function showMainMenu() {
            hideAllScreens();
            document.getElementById('main-menu').classList.remove('hidden');
            tg.MainButton.hide();
        }

        function showCharacterCreation() {
            hideAllScreens();
            document.getElementById('character-creation').classList.remove('hidden');
            tg.MainButton.hide();
        }

        function showDiceRoll() {
            hideAllScreens();
            document.getElementById('dice-roll').classList.remove('hidden');
            tg.MainButton.hide();
        }

        function showSession() {
            hideAllScreens();
            document.getElementById('session-state').classList.remove('hidden');
            loadSessionData();
            tg.MainButton.hide();
        }

        function hideAllScreens() {
            const screens = ['main-menu', 'character-creation', 'dice-roll', 'session-state'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        function saveCharacter() {
            const name = document.getElementById('char-name').value;
            const ancestry = document.getElementById('char-ancestry').value;
            const charClass = document.getElementById('char-class').value;

            if (!name || !ancestry || !charClass) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
                return;
            }

            const character = {
                name: name,
                ancestry: ancestry,
                class: charClass,
                traits: {
                    strength: parseInt(document.getElementById('strength').value),
                    agility: parseInt(document.getElementById('agility').value),
                    finesse: parseInt(document.getElementById('finesse').value),
                    instinct: parseInt(document.getElementById('instinct').value),
                    presence: parseInt(document.getElementById('presence').value),
                    knowledge: parseInt(document.getElementById('knowledge').value)
                },
                hit_points: 20,
                max_hit_points: 20,
                stress: 0,
                armor_slots: 3
            };

            currentCharacter = character;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
            if (typeof(Storage) !== "undefined") {
                localStorage.setItem('daggerheart_character', JSON.stringify(character));
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
            tg.sendData(JSON.stringify({
                type: 'character_created',
                character: character
            }));

            tg.showAlert('–ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!');
            showMainMenu();
        }

        // –°–∏—Å—Ç–µ–º–∞ –±—Ä–æ—Å–∫–æ–≤ –∫—É–±–∏–∫–æ–≤
        function rollDice() {
            const rollButton = document.getElementById('roll-button');
            const hopeDice = document.getElementById('hope-dice');
            const fearDice = document.getElementById('fear-dice');
            const resultDiv = document.getElementById('roll-result');

            rollButton.disabled = true;
            hopeDice.classList.add('rolling');
            fearDice.classList.add('rolling');

            // –°–∏–º—É–ª–∏—Ä—É–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –±—Ä–æ—Å–∫–∞
            let rollCount = 0;
            const rollInterval = setInterval(() => {
                hopeDice.textContent = Math.floor(Math.random() * 12) + 1;
                fearDice.textContent = Math.floor(Math.random() * 12) + 1;
                rollCount++;

                if (rollCount >= 10) {
                    clearInterval(rollInterval);
                    finishRoll();
                }
            }, 50);
        }

        function finishRoll() {
            const hopeDice = document.getElementById('hope-dice');
            const fearDice = document.getElementById('fear-dice');
            const resultDiv = document.getElementById('roll-result');
            const rollButton = document.getElementById('roll-button');

            // –§–∏–Ω–∞–ª—å–Ω—ã–π –±—Ä–æ—Å–æ–∫
            const hopeRoll = Math.floor(Math.random() * 12) + 1;
            const fearRoll = Math.floor(Math.random() * 12) + 1;

            hopeDice.textContent = hopeRoll;
            fearDice.textContent = fearRoll;

            hopeDice.classList.remove('rolling');
            fearDice.classList.remove('rolling');

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            const difficulty = parseInt(document.getElementById('difficulty').value);
            const traitMod = getTraitModifier();
            const total = Math.max(hopeRoll, fearRoll) + traitMod;

            let resultText = '';
            let resultClass = '';

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Å–ø–µ—Ö
            if (hopeRoll === fearRoll) {
                resultText = `üåü –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–°–ü–ï–•! (${hopeRoll}/${fearRoll} + ${traitMod} = ${total})`;
                resultClass = 'critical';
            } else if (total >= difficulty) {
                if (hopeRoll > fearRoll) {
                    resultText = `‚úÖ –£—Å–ø–µ—Ö —Å –ù–∞–¥–µ–∂–¥–æ–π! (${total} ‚â• ${difficulty})`;
                    resultClass = 'success';
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–¥–µ–∂–¥—É
                    sessionData.hope++;
                } else {
                    resultText = `‚úÖ –£—Å–ø–µ—Ö —Å–æ –°—Ç—Ä–∞—Ö–æ–º (${total} ‚â• ${difficulty})`;
                    resultClass = 'success';
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–∞—Ö
                    sessionData.fear++;
                }
            } else {
                resultText = `‚ùå –ù–µ—É–¥–∞—á–∞ (${total} < ${difficulty})`;
                resultClass = 'failure';
                if (fearRoll > hopeRoll) {
                    sessionData.fear++;
                }
            }

            resultDiv.innerHTML = resultText;
            resultDiv.className = `roll-result ${resultClass}`;
            resultDiv.classList.remove('hidden');

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–æ—Ç—É
            tg.sendData(JSON.stringify({
                type: 'dice_roll',
                hope: hopeRoll,
                fear: fearRoll,
                modifier: traitMod,
                total: total,
                difficulty: difficulty,
                success: total >= difficulty,
                critical: hopeRoll === fearRoll,
                rollWithHope: hopeRoll > fearRoll
            }));

            rollButton.disabled = false;
        }

        function getTraitModifier() {
            const traitSelect = document.getElementById('trait-modifier');
            const selectedTrait = traitSelect.value;

            if (selectedTrait === '0' || !currentCharacter) {
                return 0;
            }

            return currentCharacter.traits[selectedTrait] || 0;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–∏
        function loadSessionData() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
            if (typeof(Storage) !== "undefined") {
                const savedCharacter = localStorage.getItem('daggerheart_character');
                if (savedCharacter) {
                    currentCharacter = JSON.parse(savedCharacter);
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateSessionDisplay();
        }

        function updateSessionDisplay() {
            document.getElementById('session-fear').textContent = sessionData.fear;
            document.getElementById('session-hope').textContent = sessionData.hope;

            const characterInfo = document.getElementById('character-info');
            if (currentCharacter) {
                characterInfo.innerHTML = `
                    <strong>${currentCharacter.name}</strong><br>
                    ${currentCharacter.ancestry} ${currentCharacter.class}<br>
                    üíñ ${currentCharacter.hit_points}/${currentCharacter.max_hit_points} HP<br>
                    üò∞ ${currentCharacter.stress} –°—Ç—Ä–µ—Å—Å
                `;
            } else {
                characterInfo.innerHTML = '<p>–ü–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ —Å–æ–∑–¥–∞–Ω</p>';
            }

            const sceneInfo = document.getElementById('current-scene');
            if (sessionData.scene) {
                sceneInfo.innerHTML = `<p>${sessionData.scene}</p>`;
            } else {
                sceneInfo.innerHTML = '<p>–°—Ü–µ–Ω–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</p>';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL
        function handleUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            const sessionId = urlParams.get('session_id');

            if (action === 'create_character') {
                showCharacterCreation();
            } else if (action === 'dice_roll') {
                showDiceRoll();
            } else if (sessionId) {
                showSession();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', function() {
            handleUrlParams();
            loadSessionData();

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫ Telegram
            tg.MainButton.setText('–ó–∞–∫—Ä—ã—Ç—å');
            tg.MainButton.onClick(() => tg.close());

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞
            tg.onEvent('receiveData', function(data) {
                try {
                    const parsedData = JSON.parse(data);
                    if (parsedData.type === 'session_update') {
                        sessionData = { ...sessionData, ...parsedData.data };
                        updateSessionDisplay();
                    }
                } catch (e) {
                    console.error('Error parsing received data:', e);
                }
            });
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã
        tg.onEvent('themeChanged', function() {
            document.documentElement.style.setProperty('--tg-color-scheme', tg.colorScheme);
        });
    </script>
</body>
</html>