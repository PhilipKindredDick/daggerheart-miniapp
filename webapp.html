<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daggerheart</title>
    <script src="https://telegram.org/js/telegram-web-app.js?57"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 10px;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #0088cc);
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--tg-theme-hint-color, #666666);
            font-size: 14px;
        }

        .card {
            background: var(--tg-theme-secondary-bg-color, #f7f7f7);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 8px;
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
        }

        .button {
            display: block;
            width: 100%;
            padding: 12px 16px;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 8px;
            transition: opacity 0.2s;
        }

        .button:hover {
            opacity: 0.8;
        }

        .button.secondary {
            background: var(--tg-theme-secondary-bg-color, #f7f7f7);
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
        }

        .hidden {
            display: none !important;
        }

        .character-card {
            display: flex;
            gap: 16px;
            margin-bottom: 8px;
            align-items: flex-start;
        }

        .character-portrait {
            flex-shrink: 0;
            margin-top: 30px; 
        }

        .character-portrait img {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            border: 3px solid var(--tg-theme-button-color, #0088cc);
            object-fit: cover;
            background: var(--tg-theme-secondary-bg-color, #f7f7f7);
        }

        .character-info {
            flex: 1;
            min-width: 0;
        }

        .form-group {
            margin-bottom: 0px;
        }

        .form-label {
            display: block;
            margin-top: 3%;
            margin-bottom: 2%;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
            border-radius: 8px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
        }

        .gender-row-wrapper {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 0px;
            margin-right: 28px;
        }

        .gender-selector {
            display: flex;
            flex-direction: row;
            gap: 8px;
            justify-content: center;
            align-items: center;
            width: 100%;  
        }

        .gender-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 0px;
            background: none;
            border: none;
            border-radius: 8px;
            min-width: 90px;
            max-width: 90px;
            width: 90px; 
            box-sizing: border-box;
            margin-right: 28px;
        }

        .gender-slot .stat-label {
            font-size: 16px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
            text-align: center;
            line-height: 1.2;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 2px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 11px 16px;
            border-radius: 8px;
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
            background: var(--tg-theme-bg-color, #ffffff);
            transition: all 0.2s;
        }

        .radio-option:hover {
            background: var(--tg-theme-section-bg-color, #f0f0f0);
        }

        .radio-option input[type="radio"] {
            margin: 0;
        }

        .info-button {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }

        .stat-item {
            text-align: center;
            padding: 5px;
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            border-radius: 8px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--tg-theme-text-color, #000000);
        }

        .stat-value[readonly] {
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            color: var(--tg-theme-text-color, #000000);
            display: flex;
            align-items: center;
            justify-content: center;
        }

    /* Стили для модальных окон */

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: var(--tg-theme-bg-color, #ffffff);
            margin: 10% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--tg-theme-text-color, #000000);
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--tg-theme-hint-color, #666666);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-button:hover {
            color: var(--tg-theme-text-color, #000000);
        }

    /* Стили для модального окна пончиков */
    
        .notification-modal {
            display: none;
            position: fixed;
            z-index: 1500;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s ease;
        }

        .notification-content {
            background-color: var(--tg-theme-bg-color, #ffffff);
            margin: 20% auto;
            padding: 24px;
            border-radius: 16px;
            width: 85%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .notification-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #0088cc);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .notification-text {
            color: var(--tg-theme-text-color, #000000);
            line-height: 1.5;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .notification-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .notification-button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
            min-width: 100px;
        }

        .notification-button.primary {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .notification-button.secondary {
            background: var(--tg-theme-secondary-bg-color, #f7f7f7);
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
        }

        .notification-button:hover {
            opacity: 0.8;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .donut-icon {
            display: inline-block;
            font-size: 18px;
        }

        /* Стили для курсора пончиков */
        .stat-value[readonly] {
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            color: var(--tg-theme-text-color, #000000);
            cursor: pointer; /* Добавляем курсор указатель */
        }

        .stat-value[readonly]:hover {
            background: var(--tg-theme-section-separator-color, #e1e1e1);
            transition: background 0.2s ease;
        }

    /* Стили для броска кубиков */

        .dice-container {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin: 24px 0;
        }

        .dice {
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #f0f0f0, #d0d0d0);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .dice.hope {
            background: linear-gradient(145deg, #4CAF50, #388E3C);
            color: white;
        }

        .dice.fear {
            background: linear-gradient(145deg, #F44336, #D32F2F);
            color: white;
        }

        .dice.rolling {
            animation: roll 0.5s ease-in-out;
        }

        @keyframes roll {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
        }

        .roll-result {
            text-align: center;
            padding: 20px;
            margin: 16px 0;
            border-radius: 12px;
            font-weight: bold;
        }

        .roll-result.success {
            background: #E8F5E8;
            color: #2E7D32;
            border: 2px solid #4CAF50;
        }

        .roll-result.failure {
            background: #FFEBEE;
            color: #C62828;
            border: 2px solid #F44336;
        }

        .roll-result.critical {
            background: #FFF3E0;
            color: #E65100;
            border: 2px solid #FF9800;
        }

    /* Стили для системы правил и гиперссылок */
        .rules-link {
            color: var(--tg-theme-link-color, #0088cc);
            text-decoration: underline;
            cursor: pointer;
            font-style: italic;
        }

        .rules-link:hover {
            opacity: 0.7;
        }

        .ancestry-description {
            line-height: 1.6;
            margin: 16px 0;
        }

        .ancestry-description strong {
            font-weight: bold;
            color: var(--tg-theme-text-color, #000000);
        }

        .ability-title {
            font-weight: bold;
            margin-top: 8px;
            margin-bottom: 4px;
        }

        .rules-content {
            line-height: 1.5;
        }

        .rules-section {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            border-radius: 8px;
        }

        .rules-section h3 {
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
        }

        .breadcrumb {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666666);
            margin-bottom: 16px;
        }

    /* Стили для доменов */
        .class-domains-row {
            display: flex;
            gap: 13px;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .class-group {
            flex: 1;
            margin-bottom: 0;
            margin-top: 0px;
        }

        .domains-group {
            flex-shrink: 0;
            margin-bottom: 0;
        }

        .domains-group .form-label {
            text-align: center;
            width: 100%;
            display: block;
        }

        .domains-container {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 7px;
        }

        .domain-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 6px;
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
            border-radius: 8px;
            min-width: 70px;      
            max-width: 70px;
            width: 70px;
            box-sizing: border-box;
        }

        .domain-icon {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            object-fit: cover;
            border-radius: 8px;
            object-fit: contain;
            background: transparent;
            padding: 4px;
            box-sizing: border-box;
        }

        .domain-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
            text-align: center;
            line-height: 1.2;
            max-width: 80px;      
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

    /* Стили для защиты и уклонения */
        .defense-row-wrapper {
            display: flex;
            justify-content: flex-end;
            margin-top: 0;
            margin-bottom: 8px;
            margin-right: 0;
        }

        .defense-row {
            display: flex;
            gap: 8px;
        }

        .defense-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
            padding: 8px 0;
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            border-radius: 8px;
            min-width: 70px;
        }

        .defense-item .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 2px;
            line-height: 1;
            width: 2.5em;
            text-align: center;
            user-select: none;
            pointer-events: none;
            background: none; 
            border: none; 
            padding: 0;
        }

        .defense-item .stat-label {
            font-size: 12px;
            color: var(--tg-theme-text-color, #000000);
            text-align: center;
            line-height: 1.2;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin: 0;
        }

    /* Стили для гендера */
        .background-gender-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            margin-bottom: 4px;
        }

        .background-gender-row .gender-slot {
             margin-left: 28px;
        }

        .background-group {
            flex: 1;
            min-width: 0;
        }

    /* Стили для шкал */
        .track-fields-row {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
        }

        .track-group {
            flex: 1;
        }

        .track-scale {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-content: center;
            padding: 8px;
            padding-left: 15px; 
            padding-right: 13px;
            background: #f0f0f0;
            border-radius: 8px;
            border: 1px solid #e1e1e1;
            min-height: 50px;
        }

        .track-box {
            width: 15px;
            height: 15px;
            border: 1px solid #333;
            border-radius: 4px;
            flex-shrink: 0;
            display: inline-block;
        }

        .track-box.filled {
            background-color: #0088cc;
        }

        .track-box.empty {
            background-color: #ffffff;
        }

    /* Стили для надежды */
        .hope-defense-container {
            display: flex;
            gap: 18px;
            align-items: center;
            width: 100%;
        }

        .hope-track-group {
            flex: 1;
            margin-right: 0;
            margin-left: 0;
            align-self: center;
            width: auto;
            margin-top: -20px;
        }

        .hope-track-group .form-label {
            font-size: 16px;
            color: var(--tg-theme-text-color, #000000);
            text-align: center;
            margin-bottom: 4px;
        }

        .hope-track {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            justify-content: center;
            align-content: center; 
            padding: 8px;
            background: #f0f0f0;
            border-radius: 8px;
            border: 1px solid #e1e1e1;
            min-height: 50px;
            box-sizing: border-box;
        }

        .hope-track .track-box {
            width: 15px;
            height: 15px;
            border: 1px solid #333;
            border-radius: 3px;
        }

    /* Стили для инвентаря */
        .inventory-section {
            margin-bottom: 24px;
        }

        .armor-slot {
            display: flex;
            gap: 16px;
            align-items: flex-start;
            padding: 16px;
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            border-radius: 12px;
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
        }

        .armor-image {
            width: 100px;
            height: 143px; /* Соотношение 7:10 */
            border-radius: 8px;
            object-fit: contain; /* Изменяем с cover на contain */
            background: var(--tg-theme-bg-color, #ffffff);
            border: 2px solid var(--tg-theme-section-separator-color, #e1e1e1);
            flex-shrink: 0;
            padding: 4px;
            box-sizing: border-box;
        }

        .weapons-section {
            margin-bottom: 24px;
        }

        .weapons-row {
            display: flex;
            gap: 16px;
            justify-content: space-between;
        }

        .weapon-slot {
            flex: 1;
            padding: 16px;
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            border-radius: 12px;
            border: 1px solid var(--tg-theme-section-separator-color, #e1e1e1);
            text-align: center;
        }

        .weapon-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 8px;
        }

        .weapon-image {
            width: 100px;
            height: 177px; /* Соотношение 9:16 */
            border-radius: 8px;
            object-fit: contain; /* Изменяем с cover на contain */
            background: var(--tg-theme-bg-color, #ffffff);
            border: 2px solid var(--tg-theme-section-separator-color, #e1e1e1);
            margin: 0 auto 12px auto;
            display: block;
            padding: 4px;
            box-sizing: border-box;
        }

        .weapon-image.second-hand {
            opacity: 0.25; /* Делаем картинку бледнее */
        }

        .item-stats {
            flex: 1;
            min-width: 0;
        }

        .stat-line {
            font-size: 14px;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 4px;
            text-align: left;
        }

        .weapon-slot .stat-line {
            text-align: left;
        }

        .stat-line span {
            font-weight: 500;
            color: var(--tg-theme-button-color, #0088cc);
        }

        /* Стиль для названий предметов */
        .stat-line:first-child {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
        }

        .stat-line:first-child span {
            font-weight: bold;
            color: var(--tg-theme-text-color, #000000);
        }

        /* Стили для курсора на изображениях брони и оружия */
        .armor-image, .weapon-image {
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .armor-image:hover, .weapon-image:hover {
            opacity: 0.8;
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- Главное меню -->
        <div id="main-menu">
            <div class="header">
                <div class="title">⚔️ Daggerheart</div>
                <div class="subtitle">Мобильная ролевая игра</div>
            </div>

            <div class="card">
                <button class="button secondary" id="game-button" onclick="startGame()">
                    🎮 ИГРА
                </button>
                <button class="button" onclick="showCharacterCreation()">
                    🎭 Создать персонажа
                </button>
            <button class="button secondary" id="session-button" onclick="showSession()">
                📊 Состояние сессии
            </button>
            <button class="button secondary" onclick="showDiceRoll()">
                🎲 Бросить кубики
            </button>
                <button class="button secondary" onclick="showRules()">
                    📚 Правила
                </button>
            </div>
        </div>

        <!-- Создание персонажа -->
        <div id="character-creation" class="hidden">
            <div class="header">
                <div class="title">🎭 Создание персонажа</div>
            </div>

            <div class="card">
                <!-- Карточка персонажа -->
                <div class="character-card">
                    <div class="character-portrait">
                        <img id="char-portrait" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTEwIiBoZWlnaHQ9IjExMCIgdmlld0JveD0iMCAwIDExMCAxMTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMTEiIGhlaWdodD0iMTEwIiByeD0iNTUiIGZpbGw9IiNGNUY1RjUiLz4KPHN2ZyB4PSIzMCIgeT0iMjUiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCI+CiAgPGNpcmNsZSBjeD0iMjUiIGN5PSIyMCIgcj0iMTIiIGZpbGw9IiNERCQiLz4KICA8ZWxsaXBzZSBjeD0iMjUiIGN5PSI0NSIgcng9IjE4IiByeT0iMjAiIGZpbGw9IiNERCQiLz4KPC9zdmc+Cjwvc3ZnPg==" alt="Портрет персонажа">
                    </div>
                    <div class="character-info">
                        <div class="form-group">
                            <label class="form-label">Имя персонажа</label>
                            <input type="text" class="form-input" id="char-name" placeholder="Введите имя" onchange="updatePortrait()">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                Происхождение
                                <button class="info-button" onclick="showBackgroundInfo()" title="Информация о происхождении">?</button>
                            </label>
                            <select class="form-select" id="char-background">
                                <option value="">Выбрать</option>
                                <option value="noble">Великородное</option>
                                <option value="military">Военное</option>
                                <option value="mountain">Горное</option>
                                <option value="dogmatic">Догматичное</option>
                                <option value="lost">Заблудшее</option>
                                <option value="nomadic">Кочевое</option>
                                <option value="criminal">Криминальное</option>
                                <option value="forest">Лесное</option>
                                <option value="frost">Морозное</option>
                                <option value="sea">Морское</option>
                                <option value="scientific">Научное</option>
                                <option value="liberated">Освобождённое</option>
                                <option value="underground">Подземное</option>
                                <option value="desert">Пустынное</option>
                                <option value="rural">Сельское</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="background-gender-row">
                    <div class="form-group background-group">
                        <label class="form-label">
                            Родословная 
                            <button class="info-button" onclick="showAncestryInfo()" title="Информация о родословной">?</button>
                        </label>
                        <select class="form-select" id="char-ancestry" onchange="updatePortrait()">
                            <option value="">Выбрать</option>
                            <option value="akvan">Акван</option>
                            <option value="aeris">Аэрис</option>
                            <option value="giant">Великан</option>
                            <option value="galapa">Галапа</option>
                            <option value="gnome">Гном</option>
                            <option value="goblin">Гоблин</option>
                            <option value="dwarf">Дварф</option>
                            <option value="dragonid">Драконид</option>
                            <option value="ignis">Игнис</option>
                            <option value="infernis">Инфернис</option>
                            <option value="katari">Катари</option>
                            <option value="clank">Кланк</option>
                            <option value="orc">Орк</option>
                            <option value="halfling">Полурослик</option>
                            <option value="ribbet">Риббет</option>
                            <option value="simian">Симиан</option>
                            <option value="terran">Терран</option>
                            <option value="faun">Фавн</option>
                            <option value="fangril">Фангрил</option>
                            <option value="faerie">Фейри</option>
                            <option value="firbolg">Фирболг</option>
                            <option value="human">Человек</option>
                            <option value="elf">Эльф</option>
                            <option value="etheris">Эфирис</option>
                        </select>
                    </div>
                    <div class="gender-slot">
                        <label class="stat-label">Гендер</label>
                        <div class="gender-selector">
                            <label class="radio-option">
                                <input type="radio" name="gender" value="male" checked onchange="updatePortrait()">
                                <span>♂</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="gender" value="female" onchange="updatePortrait()">
                                <span>♀</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="class-domains-row">
                    <div class="form-group class-group">
                        <label class="form-label">
                            Класс
                            <button class="info-button" onclick="showClassInfo()" title="Информация о классе">?</button>
                        </label>
                        <select class="form-select" id="char-class" onchange="updateDomains()">
                            <option value="">Выбрать</option>
                            <option value="bard">Бард</option>
                            <option value="rogue">Плут</option>
                            <option value="sorcerer">Чародей</option>
                            <option value="druid">Друид</option>
                            <option value="ranger">Следопыт</option>
                            <option value="warrior">Воин</option>
                            <option value="guardian">Страж</option>
                            <option value="seraph">Серафим</option>
                            <option value="wizard">Волшебник</option>
                        </select>
                    </div>

                    <div class="form-group domains-group">
                        <label class="form-label">ДОМЕНЫ</label>
                        <div class="domains-container">
                            <div class="domain-slot" id="domain-1">
                                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNiIgZmlsbD0iI0Y1RjVGNSIvPgo8dGV4dCB4PSIxNiIgeT0iMjEiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iI0RERCIgdGV4dC1hbmNоб3I9Im1pZGRsZSI+PzwvdGV4dD4KPC9zdmc+" alt="Домен 1" class="domain-icon">
                                <span class="domain-name">-</span>
                            </div>
                            <div class="domain-slot" id="domain-2">
                                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNiIgZmlsbD0iI0Y1RjVGNSIvPgo8dGV4dCB4PSIxNiIgeT0iMjEiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iI0RERCIgdGV4dC1hbmNоb3I9Im1pZGRsZSI+PzwvdGV4dD4KPC9zdmc+" alt="Домен 2" class="domain-icon">
                                <span class="domain-name">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="defense-row-wrapper">
                    <div class="hope-defense-container">
                        <div class="track-group hope-track-group">
                            <label class="form-label">НАДЕЖДА</label>
                            <div class="track-scale hope-track" id="hope-track">
                                <div class="track-box filled"></div>
                                <div class="track-box filled"></div>
                                <div class="track-box empty"></div>
                                <div class="track-box empty"></div>
                                <div class="track-box empty"></div>
                                <div class="track-box empty"></div>
                            </div>
                        </div>
                        <div class="defense-row">
                            <div class="defense-item">
                                <div class="stat-value" id="evasion" readonly>0</div>
                                <div class="stat-label">Уклонение</div>
                            </div>
                            <div class="defense-item">
                                <div class="stat-value" id="armor" readonly>0</div>
                                <div class="stat-label">Броня</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="track-fields-row">
                    <div class="track-group">
                        <label class="form-label">Жизнь</label>
                        <div class="track-scale" id="life-track">
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                        </div>
                    </div>
                    
                    <div class="track-group">
                        <label class="form-label">Драма</label>
                        <div class="track-scale" id="drama-track">
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box filled"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                            <div class="track-box empty"></div>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Сила</div>
                        <input type="number" class="stat-value" id="strength" value="0" min="-3" max="3" readonly onclick="showStatsMessage()">
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Ловкость</div>
                        <input type="number" class="stat-value" id="agility" value="0" min="-3" max="3" readonly onclick="showStatsMessage()">
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Грация</div>
                        <input type="number" class="stat-value" id="finesse" value="0" min="-3" max="3" readonly onclick="showStatsMessage()">
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Интуиция</div>
                        <input type="number" class="stat-value" id="instinct" value="0" min="-3" max="3" readonly onclick="showStatsMessage()">
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Харизма</div>
                        <input type="number" class="stat-value" id="presence" value="0" min="-3" max="3" readonly onclick="showStatsMessage()">
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Интеллект</div>
                        <input type="number" class="stat-value" id="knowledge" value="0" min="-3" max="3" readonly onclick="showStatsMessage()">
                    </div>
                </div>

                <button class="button" onclick="saveCharacter()">
                    ✅ Сохранить персонажа
                </button>
                <button class="button secondary" onclick="showMainMenu()">
                    ← Назад
                </button>
            </div>
        </div>

    <!-- Состояние сессии -->
        <div id="session-state" class="hidden">
            <div class="header">
                <div class="title">📊 Состояние сессии</div>
            </div>

            <div class="card">

                <div class="form-group">
                    <label class="form-label">👤 Мой персонаж</label>
                    <div id="character-info">
                        <p>Персонаж не создан</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">🎒 Инвентарь</label>
                    <div id="inventory-info">
                        <p>Персонаж не создан</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">🌍 Текущая сцена</label>
                    <div id="current-scene">
                        <p>Сцена не установлена</p>
                    </div>
                </div>

                <button class="button secondary" onclick="showMainMenu()">← Назад</button>
            </div>
        </div>

        <!-- Бросок кубиков -->
        <div id="dice-roll" class="hidden">
            <div class="header">
                <div class="title">🎲 Бросок кубиков</div>
            </div>

            <div class="card">
                <div class="form-group">
                    <label class="form-label">Тип броска</label>
                    <select class="form-select" id="roll-type">
                        <option value="action">Бросок действия</option>
                        <option value="attack">Бросок атаки</option>
                        <option value="damage">Бросок урона</option>
                        <option value="reaction">Бросок реакции</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Характеристика</label>
                    <select class="form-select" id="trait-modifier">
                        <option value="0">Без модификатора</option>
                        <option value="strength">Сила</option>
                        <option value="agility">Ловкость</option>
                        <option value="finesse">Грация</option>
                        <option value="instinct">Интуиция</option>
                        <option value="presence">Харизма</option>
                        <option value="knowledge">Интеллект</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Сложность</label>
                    <input type="number" class="form-input" id="difficulty" value="12" min="5" max="20">
                </div>

                <div class="dice-container">
                    <div class="dice hope" id="hope-dice">?</div>
                    <div class="dice fear" id="fear-dice">?</div>
                </div>

                <button class="button" onclick="rollDice()" id="roll-button">
                    🎲 Бросить кости дуальности
                </button>

                <div id="roll-result" class="hidden"></div>

                <button class="button secondary" onclick="showMainMenu()">
                    ← Назад
                </button>
            </div>
        </div>

        <!-- Экран правил с глоссарием и навигацией -->
        <div id="rules" class="hidden">
            <div class="header">
                <div class="title">📚 Правила</div>
            </div>

            <div class="card">
                <div class="breadcrumb" id="rules-breadcrumb">Правила</div>
                
                <div id="rules-main">
                    <div class="form-group">
                        <label class="form-label">Разделы правил</label>
                        <button class="button secondary" onclick="showRulesSection('distances')">🎯 Дистанции</button>
                        <button class="button secondary" onclick="showRulesSection('combat')">⚔️ Бой</button>
                        <button class="button secondary" onclick="showRulesSection('glossary')">📖 Глоссарий</button>
                    </div>
                </div>

                <div id="rules-distances" class="hidden">
                    <div class="rules-content">
                        <h3>🎯 Дистанции</h3>
                        <div class="rules-section">
                            <h4>Вплотную</h4>
                            <p>Ваш персонаж находится на расстоянии, позволяющем коснуться цели. Персонаж может коснуться цели, находящийся на расстоянии до метра от него. Имейте в виду, что дистанция Вплотную может быть больше для особо крупных персонажей.</p>
                        </div>
                        <div class="rules-section">
                            <h4>Близко</h4>
                            <p>Короткое расстояние в пределах прямой видимости.</p>
                        </div>
                        <div class="rules-section">
                            <h4>Средне</h4>
                            <p>Ваш персонаж находится достаточно близко к цели, чтобы видеть ее в основных деталях, например, с другого конца комнаты или соседнего рыночного прилавка. Это расстояние составляет примерно от 3 до 9 метров. Находясь в опасности, персонаж может переместиться Вплотную к любой цели, находящейся в пределах Средней дистанции, как часть своего действия.</p>
                        </div>
                        <div class="rules-section">
                            <h4>Далеко</h4>
                            <p>Ваш персонаж находится достаточно далеко, чтобы видеть внешний вид цели, но не детали, например, через небольшое поле боя или в конце большого коридора. Это расстояние составляет примерно от 9 до 30 метров. Пока персонаж находится в опасности, Мастер может попросить его совершить бросок Проворности, чтобы безопасно переместиться Вплотную к любой цели, находящейся в пределах Далекой дистанции.</p>
                        </div>
                    </div>
                </div>

                <div id="rules-combat" class="hidden">
                    <div class="rules-content">
                        <h3>⚔️ Бой</h3>
                        <div class="rules-section">
                            <h4>Раны</h4>
                            <p>Раны представляют физическое здоровье и выносливость персонажа.</p>
                        </div>
                        <div class="rules-section">
                            <h4>Мастерство</h4>
                            <p>Ваше мастерство определяет количество костей урона при успешной атаке.</p>
                        </div>
                        <div class="rules-section">
                            <h4>Один раз за сессию</h4>
                            <p>Некоторые свойства говорят, что вы можете использовать их "один раз за сессию". Эти свойства не обновляются во время отдыха, но вместо этого становятся доступны в начале вашей следующей сессии Daggerheart. Если ваш стол решает играть в одну долгую сессию, Мастер может решить, что все способности "один раз за сессию" обновляются во время перерыва в игре.</p>
                        </div>
                    </div>
                </div>

                <div id="rules-glossary" class="hidden">
                    <div class="rules-content">
                        <h3>📖 Глоссарий</h3>
                        <div class="rules-section">
                            <h4>В</h4>
                            <p><span class="rules-link" onclick="showRulesSection('distances')">Вплотную</span></p>
                        </div>
                        <div class="rules-section">
                            <h4>Д</h4>
                            <p><span class="rules-link" onclick="showRulesSection('distances')">Далеко</span></p>
                        </div>
                        <div class="rules-section">
                            <h4>И</h4>
                            <p><span class="rules-link" onclick="showRulesSection('glossary')">Искусность</span></p>
                        </div>
                        <div class="rules-section">
                            <h4>М</h4>
                            <p><span class="rules-link" onclick="showRulesSection('combat')">Мастерство</span></p>
                        </div>
                        <div class="rules-section">
                            <h4>Н</h4>
                            <p><span class="rules-link" onclick="showRulesSection('glossary')">Надежда</span></p>
                        </div>
                        <div class="rules-section">
                            <h4>О</h4>
                            <p><span class="rules-link" onclick="showRulesSection('combat')">Один раз за сессию</span></p>
                        </div>
                        <div class="rules-section">
                            <h4>Р</h4>
                            <p><span class="rules-link" onclick="showRulesSection('combat')">Рана</span></p>
                        </div>
                        <div class="rules-section">
                            <h4>С</h4>
                            <p><span class="rules-link" onclick="showRulesSection('distances')">Средне</span></p>
                        </div>
                    </div>
                </div>

                <button class="button secondary" onclick="goBackFromRules()">← Назад</button>
            </div>
        </div>

        <!-- Инвентарь -->
        <div id="inventory" class="hidden">
            <div class="header">
                <div class="title">🎒 Инвентарь</div>
            </div>

            <div class="card">
                <div class="inventory-section">
                    <label class="form-label">🛡️ Броня</label>
                    <div class="armor-slot">
                        <img id="armor-image" src="" alt="Броня" class="armor-image" onclick="showInventoryMessage()">
                        <div class="item-stats" id="armor-stats">
                            <div class="stat-line" id="armor-name">Название брони</div>
                            <div class="stat-line">Защита: <span id="armor-defense">0</span></div>
                            <div class="stat-line">Тип: <span id="armor-type">-</span></div>
                            <div class="stat-line">Черта: <span id="armor-trait">-</span></div>
                        </div>
                    </div>
                </div>

                <!-- Поля для оружия -->
                <div class="weapons-section">
                    <label class="form-label">⚔️ Оружие</label>
                    <div class="weapons-row">
                        <!-- Основная рука -->
                        <div class="weapon-slot">
                            <div class="weapon-label">Основная рука</div>
                            <img id="main-weapon-image" src="" alt="Основное оружие" class="weapon-image" onclick="showInventoryMessage()">
                            <div class="item-stats" id="main-weapon-stats">
                                <div class="stat-line" id="main-weapon-name">Название оружия</div>
                                <div class="stat-line">Урон: <span id="main-weapon-damage">-</span></div>
                                <div class="stat-line">Тип: <span id="main-weapon-type">-</span></div>
                                <div class="stat-line">Дист.: <span id="main-weapon-range">-</span></div>
                                <div class="stat-line">Черта: <span id="main-weapon-trait">-</span></div>
                            </div>
                        </div>

                        <!-- Вторая рука -->
                        <div class="weapon-slot">
                            <div class="weapon-label">Вторая рука</div>
                            <img id="off-weapon-image" src="" alt="Вспомогательное оружие" class="weapon-image" onclick="showInventoryMessage()">
                            <div class="item-stats" id="off-weapon-stats">
                                <div class="stat-line" id="off-weapon-name">Название оружия</div>
                                <div class="stat-line">Урон: <span id="off-weapon-damage">-</span></div>
                                <div class="stat-line">Тип: <span id="off-weapon-type">-</span></div>
                                <div class="stat-line">Дист.: <span id="off-weapon-range">-</span></div>
                                <div class="stat-line">Черта: <span id="off-weapon-trait">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="button secondary" onclick="showSession()">← Назад</button>
            </div>
        </div>

        <!-- Игровой экран -->
        <div id="game-screen" class="hidden">
            <div class="header">
                <div class="title">🎮 Daggerheart</div>
                <div class="subtitle" id="scene-location">Локация не установлена</div>
            </div>

            <div class="card">
                <!-- Область истории игры -->
                <div id="game-log" class="game-log">
                    <div class="gm-message">
                        <strong>ГМ:</strong> Добро пожаловать в мир Daggerheart! Игра начинается...
                    </div>
                </div>

                <!-- Предложения ходов от ГМ -->
                <div id="action-suggestions" class="action-suggestions hidden">
                    <label class="form-label">Предлагаемые действия:</label>
                    <div id="suggestions-list"></div>
                </div>

                <!-- Поле ввода действий игрока -->
                <div class="form-group">
                    <label class="form-label">Ваше действие:</label>
                    <textarea class="form-input" id="player-action" placeholder="Опишите что вы хотите сделать..." rows="3"></textarea>
                    <button class="button" onclick="sendPlayerAction()" id="send-action-btn">
                        📤 Отправить действие
                    </button>
                </div>

                <!-- Панель быстрых бросков -->
                <div class="quick-rolls">
                    <label class="form-label">Быстрые броски:</label>
                    <div class="rolls-row">
                        <button class="button secondary small" onclick="quickRoll('strength')">💪 Сила</button>
                        <button class="button secondary small" onclick="quickRoll('agility')">🏃 Ловкость</button>
                        <button class="button secondary small" onclick="quickRoll('finesse')">🎯 Грация</button>
                        <button class="button secondary small" onclick="quickRoll('instinct')">🧠 Интуиция</button>
                        <button class="button secondary small" onclick="quickRoll('presence')">✨ Харизма</button>
                        <button class="button secondary small" onclick="quickRoll('knowledge')">📚 Интеллект</button>
                    </div>
                </div>

                <!-- Панель состояния персонажа -->
                <div class="character-status">
                    <div class="status-row">
                        <div class="status-item">
                            <span class="status-label">❤️ Жизнь:</span>
                            <span id="current-hp">6</span>/<span id="max-hp">6</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">🎭 Драма:</span>
                            <span id="current-drama">0</span>/12
                        </div>
                        <div class="status-item">
                            <span class="status-label">✨ Надежда:</span>
                            <span id="current-hope">2</span>/6
                        </div>
                    </div>
                </div>

                <button class="button secondary" onclick="pauseGame()">⏸️ Пауза</button>
                <button class="button secondary" onclick="endGame()">🚪 Завершить игру</button>
            </div>
        </div>

        <!-- Модальное окно для родословных -->
        <div id="ancestry-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="modal-ancestry-title">Информация о родословной</div>
                    <button class="close-button" onclick="closeAncestryModal()">&times;</button>
                </div>
                <div id="modal-ancestry-description">
                    Выберите родословную для просмотра информации.
                </div>
            </div>
        </div>

        <!-- Модальное окно для классов -->
        <div id="class-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="modal-class-title">Информация о классе</div>
                    <button class="close-button" onclick="closeClassModal()">&times;</button>
                </div>
                <div id="modal-class-description">
                    Выберите класс для просмотра информации.
                </div>
            </div>
        </div>

        <!-- Модальное окно для происхождений -->
        <div id="background-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="modal-background-title">Информация о происхождении</div>
                    <button class="close-button" onclick="closeBackgroundModal()">&times;</button>
                </div>
                <div id="modal-background-description">
                    Выберите происхождение для просмотра информации.
                </div>
            </div>
        </div>

        <!-- Модальное окно уведомления о характеристиках -->
        <div id="stats-notification-modal" class="notification-modal">
            <div class="notification-content">
                <div class="notification-title">
                    🎯 Рекомендуемый выбор
                </div>
                <div class="notification-text">
                    Используются рекомендации для выбранного класса.<br><br>
                    Возможность изменения будет доступна за пончики <span class="donut-icon">🍩</span> в будущих обновлениях!
                </div>
                <div class="notification-buttons">
                    <button class="notification-button primary" onclick="closeStatsNotification()">
                        Понятно
                    </button>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        // Конфигурация API
        const API_BASE_URL = 'https://ubiquitous-telegram-v4qrrr9j5r437j4-5000.app.github.dev';

        // Глобальные переменные
        var currentCharacter = null;
        var sessionData = {
            fear: 0,
            hope: 0,
            scene: '',
            players: []
        };

        // Состояние игры
        var gameState = {
            scene: 'Начало приключения',
            location: 'Таверна "Золотой дракон"',
            log: []
        };

        // Данные о родословных (заглушки для описаний)
        var ancestryData = {
            akvan: { 
                name: "Акван", 
                description: `<p><em>Акваны происходят от водных элементалей. Это гуманоиды, чьи тела состоят из плоти и воды.</em></p>
                
                <div class="ability-title"><strong>Источник Жизни:</strong></div>
                <p><span class="rules-link" onclick="openRulesLink('combat', 'once-per-session')">Один раз за сессию</span> вы можете использовать немного воды из окрестностей, чтобы исцелить союзника, находящегося <span class="rules-link" onclick="openRulesLink('distances', 'vplotnoyu')">Вплотную</span>. Когда вы это делаете, снимите 1 <span class="rules-link" onclick="openRulesLink('combat', 'wounds')">Рану</span> у цели.</p>
                
                <div class="ability-title"><strong>Водный Кнут:</strong></div>
                <p>Вы можете вытягивать воду из окружающей среды, чтобы использовать ее для атаки. Сделав это, считайте её как оружие <span class="rules-link" onclick="openRulesLink('glossary', 'iskusnost')">Искусности</span> со <span class="rules-link" onclick="openRulesLink('distances', 'sredne')">Средней</span> дистанцией, наносящее d6 магического урона, используя <span class="rules-link" onclick="openRulesLink('combat', 'masterstvo')">Мастерство</span>. Если вы находитесь в пределах <em>Близкой</em> дистанции от водоема, вы можете потратить <span class="rules-link" onclick="openRulesLink('glossary', 'nadezhda')">Надежду</span>, чтобы увеличить дистанцию атаки до <span class="rules-link" onclick="openRulesLink('distances', 'daleko')">Далёкой</span> и нанести d10 урона вместо этого.</p>`
            },
            aeris: { 
                name: "Аэрис", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_АЭРИС - Замените это описание на реальное из правил Daggerheart" 
            },
            giant: { 
                name: "Великан", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ВЕЛИКАН - Замените это описание на реальное из правил Daggerheart" 
            },
            galapa: { 
                name: "Галапа", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ГАЛАПА - Замените это описание на реальное из правил Daggerheart" 
            },
            gnome: { 
                name: "Гном", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ГНОМ - Замените это описание на реальное из правил Daggerheart" 
            },
            goblin: { 
                name: "Гоблин", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ГОБЛИН - Замените это описание на реальное из правил Daggerheart" 
            },
            dwarf: { 
                name: "Дварф", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ДВАРФ - Замените это описание на реальное из правил Daggerheart" 
            },
            dragonid: { 
                name: "Драконид", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ДРАКОНИД - Замените это описание на реальное из правил Daggerheart" 
            },
            ignis: { 
                name: "Игнис", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ИГНИС - Замените это описание на реальное из правил Daggerheart" 
            },
            infernis: { 
                name: "Инфернис", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ИНФЕРНИС - Замените это описание на реальное из правил Daggerheart" 
            },
            katari: { 
                name: "Катари", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_КАТАРИ - Замените это описание на реальное из правил Daggerheart" 
            },
            clank: { 
                name: "Кланк", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_КЛАНК - Замените это описание на реальное из правил Daggerheart" 
            },
            orc: { 
                name: "Орк", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ОРК - Замените это описание на реальное из правил Daggerheart" 
            },
            halfling: { 
                name: "Полурослик", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ПОЛУРОСЛИК - Замените это описание на реальное из правил Daggerheart" 
            },
            ribbet: { 
                name: "Риббет", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_РИББЕТ - Замените это описание на реальное из правил Daggerheart" 
            },
            simian: { 
                name: "Симиан", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_СИМИАН - Замените это описание на реальное из правил Daggerheart" 
            },
            terran: { 
                name: "Терран", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ТЕРРАН - Замените это описание на реальное из правил Daggerheart" 
            },
            faun: { 
                name: "Фавн", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ФАВН - Замените это описание на реальное из правил Daggerheart" 
            },
            fangril: { 
                name: "Фангрил", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ФАНГРИЛ - Замените это описание на реальное из правил Daggerheart" 
            },
            faerie: { 
                name: "Фейри", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ФЕЙРИ - Замените это описание на реальное из правил Daggerheart" 
            },
            firbolg: { 
                name: "Фирболг", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ФИРБОЛГ - Замените это описание на реальное из правил Daggerheart" 
            },
            human: { 
                name: "Человек", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ЧЕЛОВЕК - Замените это описание на реальное из правил Daggerheart" 
            },
            elf: { 
                name: "Эльф", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ЭЛЬФ - Замените это описание на реальное из правил Daggerheart" 
            },
            etheris: { 
                name: "Эфирис", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ЭФИРИС - Замените это описание на реальное из правил Daggerheart" 
            }
        };

        // Данные о классах
        var classData = {
            bard: { 
                name: "Бард", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_БАРД - Замените это описание на реальное из правил Daggerheart",
                domains: ["codex", "grace"],
                stats: { agility: 0, strength: -1, finesse: +1, instinct: 0, presence: +2, knowledge: +1 },
                evasion: 10,
                hitPoints: 5
            },
            rogue: { 
                name: "Плут", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ПЛУТ - Замените это описание на реальное из правил Daggerheart",
                domains: ["grace", "midnight"], 
                stats: { strength: -1, agility: +1, finesse: +2, instinct: +1, presence: 0, knowledge: 0 },
                evasion: 12,
                hitPoints: 6
            },
            sorcerer: { 
                name: "Чародей", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ЧАРОДЕЙ - Замените это описание на реальное из правил Daggerheart",
                domains: ["midnight", "arcana"], 
                stats: { strength: -1, agility: 0, finesse: +1, instinct: +2, presence: +1, knowledge: +0 },
                evasion: 10,
                hitPoints: 6
            },
            druid: { 
                name: "Друид", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ДРУИД - Замените это описание на реальное из правил Daggerheart",
                domains: ["arcana", "sage"], 
                stats: { strength: 0, agility: +1, finesse: +1, instinct: +2, presence: -1, knowledge: 0 },
                evasion: 10,
                hitPoints: 6
            },
            ranger: { 
                name: "Следопыт", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_СЛЕДОПЫТ - Замените это описание на реальное из правил Daggerheart",
                domains: ["sage", "bone"], 
                stats: { strength: 0, agility: +2, finesse: +1, instinct: +1, presence: -1, knowledge: 0 },
                evasion: 12,
                hitPoints: 6
            },
            warrior: { 
                name: "Воин", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ВОИН - Замените это описание на реальное из правил Daggerheart",
                domains: ["bone", "blade"], 
                stats: { strength: +1, agility: +2, finesse: 0, instinct: +1, presence: -1, knowledge: 0 },
                evasion: 11,
                hitPoints: 6
            },
            guardian: { 
                name: "Страж", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_СТРАЖ - Замените это описание на реальное из правил Daggerheart",
                domains: ["blade", "valor"], 
                stats: { strength: +2, agility: +1, finesse: -1, instinct: 0, presence: +1, knowledge: 0 },
                evasion: 9,
                hitPoints: 7
            },
            seraph: { 
                name: "Серафим", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_СЕРАФИМ - Замените это описание на реальное из правил Daggerheart",
                domains: ["valor", "splendor"], 
                stats: { strength: +2, agility: 0, finesse: 0, instinct: +1, presence: +1, knowledge: -1 },
                evasion: 9,
                hitPoints: 7
            },
            wizard: { 
                name: "Волшебник", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ВОЛШЕБНИК - Замените это описание на реальное из правил Daggerheart",
                domains: ["splendor", "codex"], 
                stats: { strength: 0, agility: -1, finesse: 0, instinct: +1, presence: +1, knowledge: +2 },
                evasion: 11,
                hitPoints: 5
            }
        };

        // Данные об экипировке по классам
        var equipmentData = {
            seraph: {
                armor: {
                    image: "images/armor/05-59-chainmail armor.png",
                    name: "Кольчужная броня",
                    defense: "+4 Броня",
                    type: "Средняя",
                    trait: "-1 Уклонение",
                    armorBonus: 4,
                    evasionBonus: -1
                },
                mainWeapon: {
                    image: "images/weapons/05-13-hallowed-axe.png",
                    name: "Святой топор",
                    damage: "d8+1 маг.",
                    type: "Одноручное",
                    range: "Вплотную",
                    trait: "-"
                },
                offWeapon: {
                    image: "images/weapons/05-50-round shield.png",
                    name: "Круглый щит",
                    damage: "d4 физ.",
                    type: "Одноручное", 
                    range: "Вплотную",
                    trait: "+1 Броня",
                    armorBonus: 1
                }
            },
            wizard: {
                armor: {
                    image: "images/armor/05-58-leather armor.png",
                    name: "Кожаные доспехи",
                    defense: "+3 Броня",
                    type: "Легкая",
                    trait: "-",
                    armorBonus: 3,
                    evasionBonus: 0
                },
                mainWeapon: {
                    image: "images/weapons/05-16-greatstaff.png",
                    name: "Великий посох",
                    damage: "d6 маг.",
                    type: "Двуручное",
                    range: "Далеко",
                    trait: "При успешной атаке бросьте дополнительный кубик урона и отбросьте кубик с наименьшим результатом."
                },
                offWeapon: {
                    image: "images/weapons/05-16-greatstaff.png",
                    name: "Великий посох",
                    damage: "-",
                    type: "-",
                    range: "-",
                    trait: "-",
                    isSecondHand: true
                }
            },
            guardian: {
                armor: {
                    image: "images/armor/05-59-chainmail armor.png",
                    name: "Кольчужная броня",
                    defense: "+4 Броня",
                    type: "Средняя",
                    trait: "-1 Уклонение",
                    armorBonus: 4,
                    evasionBonus: -1
                },
                mainWeapon: {
                    image: "images/weapons/05-15-Battleaxe.png",
                    name: "Боевой топор",
                    damage: "d10+3 физ.",
                    type: "Двуручное",
                    range: "Вплотную",
                    trait: "-"
                },
                offWeapon: {
                    image: "images/weapons/05-15-Battleaxe.png",
                    name: "Боевой топор",
                    damage: "-",
                    type: "-",
                    range: "-",
                    trait: "-",
                    isSecondHand: true
                }
            },
            warrior: {
                armor: {
                    image: "images/armor/05-59-chainmail armor.png",
                    name: "Кольчужная броня",
                    defense: "+4 Броня",
                    type: "Средняя",
                    trait: "-1 Уклонение",
                    armorBonus: 4,
                    evasionBonus: -1
                },
                mainWeapon: {
                    image: "images/weapons/05-05-longsword.png",
                    name: "Длинный меч",
                    damage: "d8+3 физ.",
                    type: "Двуручное",
                    range: "Вплотную",
                    trait: "-"
                },
                offWeapon: {
                    image: "images/weapons/05-05-longsword.png",
                    name: "Длинный меч",
                    damage: "-",
                    type: "-",
                    range: "-",
                    trait: "-",
                    isSecondHand: true
                }
            },
            ranger: {
                armor: {
                    image: "images/armor/05-58-leather armor.png",
                    name: "Кожаные доспехи",
                    defense: "+3 Броня",
                    type: "Легкая",
                    trait: "-",
                    armorBonus: 3,
                    evasionBonus: 0
                },
                mainWeapon: {
                    image: "images/weapons/05-17-longbow.png",
                    name: "Длинный лук", 
                    damage: "d6+3 физ.",
                    type: "Двуручное",
                    range: "Далеко",
                    trait: "-"
                },
                offWeapon: {
                    image: "images/weapons/05-17-longbow.png",
                    name: "Длинный лук", 
                    damage: "-",
                    type: "-",
                    range: "-",
                    trait: "-",
                    isSecondHand: true
                }
            },
            druid: {
                armor: {
                    image: "images/armor/05-58-leather armor.png",
                    name: "Кожаные доспехи",
                    defense: "+3 Броня",
                    type: "Легкая",
                    trait: "-",
                    armorBonus: 3,
                    evasionBonus: 0
                },
                mainWeapon: {
                    image: "images/weapons/05-19-shortstaff.png",
                    name: "Короткий посох",
                    damage: "d8+1 физ.",
                    type: "Одноручное",
                    range: "Близко",
                    trait: "-"
                },
                offWeapon: {
                    image: "images/weapons/05-50-round shield.png",
                    name: "Круглый щит",
                    damage: "d4 физ.",
                    type: "Одноручное",
                    range: "Вплотную",
                    trait: "+1 Броня",
                    armorBonus: 1
                }
            },
            sorcerer: {
                armor: {
                    image: "images/armor/05-57-gambeson armor.png",
                    name: "Гамбезон",
                    defense: "+3 Броня",
                    type: "Легкая",
                    trait: "+1 Уклонение",
                    armorBonus: 3,
                    evasionBonus: 1 
                },
                mainWeapon: {
                    image: "images/weapons/05-18-dualstaff.png",
                    name: "Дуальный посох",
                    damage: "d6+3 маг.",
                    type: "Двуручное",
                    range: "Далеко",
                    trait: "-"
                },
                offWeapon: {
                    image: "images/weapons/05-18-dualstaff.png",
                    name: "Дуальный посох",
                    damage: "-",
                    type: "-",
                    range: "-",
                    trait: "-",
                    isSecondHand: true
                }
            },
            rogue: {
                armor: {
                    image: "images/armor/05-57-gambeson armor.png",
                    name: "Гамбезон",
                    defense: "+3 Броня",
                    type: "Легкая",
                    trait: "+1 Уклонение",
                    armorBonus: 3,
                    evasionPenalty: 0,
                    evasionBonus: 1
                },
                mainWeapon: {
                    image: "images/weapons/05-09-dagger.png",
                    name: "Кинжал",
                    damage: "d8+1 физ.",
                    type: "Одноручное",
                    range: "Вплотную",
                    trait: "-"
                },
                offWeapon: {
                    image: "images/weapons/05-45-small dagger.png",
                    name: "Малый кинжал",
                    damage: "+2 физ.",
                    type: "Одноручное",
                    range: "Вплотную",
                    trait: "-"
                }
            },
            bard: {
                armor: {
                    image: "images/armor/05-57-gambeson armor.png",
                    name: "Гамбезон",
                    defense: "+3 Броня",
                    type: "Легкая",
                    trait: "+1 Уклонение",
                    armorBonus: 3,
                    evasionBonus: 1
                },
                mainWeapon: {
                    image: "images/weapons/05-03-rapier.png",
                    name: "Рапира",
                    damage: "d8 физ.",
                    type: "Одноручное",
                    range: "Вплотную",
                    trait: "Когда вы совершаете атаку, вы можете отметить Драму, чтобы поразить еще одно существо в пределах досягаемости."
                },
                offWeapon: {
                    image: "images/weapons/05-45-small dagger.png",
                    name: "Малый кинжал",
                    damage: "+2 физ.",
                    type: "Одноручное",
                    range: "Вплотную",
                    trait: "-"
                }
            }
};

        // Данные о происхождениях
        var backgroundData = {
            noble: { 
                name: "Великородное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ВЕЛИКОРОДНОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж происходит из знатной семьи." 
            },
            military: { 
                name: "Военное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ВОЕННОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж имеет военное прошлое." 
            },
            mountain: { 
                name: "Горное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ГОРНОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж вырос в горах." 
            },
            dogmatic: { 
                name: "Догматичное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ДОГМАТИЧНОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж следует строгим убеждениям." 
            },
            lost: { 
                name: "Заблудшее", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ЗАБЛУДШЕЕ - Замените это описание на реальное из правил Daggerheart. Персонаж потерял свой путь." 
            },
            nomadic: { 
                name: "Кочевое", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_КОЧЕВОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж всегда в движении." 
            },
            criminal: { 
                name: "Криминальное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_КРИМИНАЛЬНОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж связан с преступным миром." 
            },
            forest: { 
                name: "Лесное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ЛЕСНОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж вырос среди деревьев." 
            },
            frost: { 
                name: "Морозное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_МОРОЗНОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж закален холодом." 
            },
            sea: { 
                name: "Морское", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_МОРСКОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж связан с морем." 
            },
            scientific: { 
                name: "Научное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_НАУЧНОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж стремится к знаниям." 
            },
            liberated: { 
                name: "Освобождённое", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ОСВОБОЖДЁННОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж обрел свободу." 
            },
            underground: { 
                name: "Подземное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ПОДЗЕМНОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж вырос под землей." 
            },
            desert: { 
                name: "Пустынное", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_ПУСТЫННОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж закален пустыней." 
            },
            rural: { 
                name: "Сельское", 
                description: "ЗАГЛУШКА_ОПИСАНИЕ_СЕЛЬСКОЕ - Замените это описание на реальное из правил Daggerheart. Персонаж вырос в деревне." 
            }
        };

        // Данные о доменах
        var domainData = {
            codex:    { name: "Кодекс",    icon: "images/domaines/codex.svg" },
            grace:    { name: "Грация",    icon: "images/domaines/grace.svg" },
            midnight: { name: "Полночь",   icon: "images/domaines/midnight.svg" },
            arcana:   { name: "Аркана",    icon: "images/domaines/arcana.svg" },
            sage:     { name: "Мудрость",  icon: "images/domaines/sage.svg" },
            bone:     { name: "Кость",     icon: "images/domaines/bone.svg" },
            blade:    { name: "Клинок",    icon: "images/domaines/blade.svg" },
            valor:    { name: "Доблесть",  icon: "images/domaines/valor.svg" },
            splendor: { name: "Величие",   icon: "images/domaines/splendor.svg" }
        };
        
        var rulesFromScreen = 'main-menu';

        // Функции навигации
        function showMainMenu() {
            hideAllScreens();
            document.getElementById('main-menu').classList.remove('hidden');
            
            // Загружаем персонажа если есть
            if (typeof(Storage) !== "undefined") {
                var savedCharacter = localStorage.getItem('daggerheart_character');
                if (savedCharacter) {
                    currentCharacter = JSON.parse(savedCharacter);
                }
            }
            
            // Обновляем состояние кнопки игры
            updateMenuButtons();
        }

        function showCharacterCreation() {
            hideAllScreens();
            document.getElementById('character-creation').classList.remove('hidden');
            
            // Восстанавливаем возможность редактирования
            makeFieldsEditable();
            
            // Сброс всех полей формы
            document.getElementById('char-name').value = '';
            document.getElementById('char-ancestry').value = '';
            document.getElementById('char-background').value = '';
            document.getElementById('char-class').value = '';
            
            // Сброс радиокнопок гендера на мужской по умолчанию
            var genderRadios = document.getElementsByName('gender');
            for (var i = 0; i < genderRadios.length; i++) {
                if (genderRadios[i].value === 'male') {
                    genderRadios[i].checked = true;
                } else {
                    genderRadios[i].checked = false;
                }
            }
            
            // Сброс характеристик на 0
            document.getElementById('strength').value = 0;
            document.getElementById('agility').value = 0;
            document.getElementById('finesse').value = 0;
            document.getElementById('instinct').value = 0;
            document.getElementById('presence').value = 0;
            document.getElementById('knowledge').value = 0;
            
            // Сброс защиты
            document.getElementById('evasion').textContent = 0;
            document.getElementById('armor').textContent = 0;
            
            // Сброс доменов на заглушки
            var domain1Slot = document.getElementById('domain-1');
            var domain2Slot = document.getElementById('domain-2');
            domain1Slot.querySelector('.domain-icon').src = "images/domaines/domain-placeholder.svg";
            domain1Slot.querySelector('.domain-name').textContent = "-";
            domain2Slot.querySelector('.domain-icon').src = "images/domaines/domain-placeholder.svg";
            domain2Slot.querySelector('.domain-name').textContent = "-";
            
            // Сброс портрета на заглушку
            document.getElementById('char-portrait').src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTEwIiBoZWlnaHQ9IjExMCIgdmlld0JveD0iMCAwIDExMCAxMTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMTEiIGhlaWdodD0iMTEwIiByeD0iNTUiIGZpbGw9IiNGNUY1RjUiLz4KPHN2ZyB4PSIzMCIgeT0iMjUiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCI+CiAgPGNpcmNsZSBjeD0iMjUiIGN5PSIyMCIgcj0iMTIiIGZpbGw9IiNERCQiLz4KICA8ZWxsaXBzZSBjeD0iMjUiIGN5PSI0NSIgcng9IjE4IiByeT0iMjAiIGZpbGw9IiNERCQiLz4KPC9zdmc+Cjwvc3ZnPg==";

            // Сброс треков
            updateLifeTrack(0);
            updateDramaTrack(0);
            updateHopeTrack(2); // Базовая надежда
            
            // Восстанавливаем оригинальные кнопки создания
            restoreCreationButtons();
        }

        // Восстанавливает кнопки создания персонажа
        function restoreCreationButtons() {
            var buttonContainer = document.querySelector('#character-creation .card');
            var existingButtons = buttonContainer.querySelectorAll('.button');
            
            // Удаляем все существующие кнопки
            for (var i = existingButtons.length - 1; i >= 0; i--) {
                existingButtons[i].remove();
            }
            
            // Добавляем оригинальные кнопки
            var saveButton = document.createElement('button');
            saveButton.className = 'button';
            saveButton.onclick = saveCharacter;
            saveButton.innerHTML = '✅ Сохранить персонажа';
            
            var backButton = document.createElement('button');
            backButton.className = 'button secondary';
            backButton.onclick = showMainMenu;
            backButton.innerHTML = '← Назад';
            
            buttonContainer.appendChild(saveButton);
            buttonContainer.appendChild(backButton);
        }

        function showDiceRoll() {
            hideAllScreens();
            document.getElementById('dice-roll').classList.remove('hidden');
        }

        function showSession() {
            hideAllScreens();
            document.getElementById('session-state').classList.remove('hidden');
            loadSessionData();
        }

        function showRules() {
            rulesFromScreen = getCurrentScreen();
            hideAllScreens();
            document.getElementById('rules').classList.remove('hidden');
            showRulesMain();
        }

        function showRulesMain() {
            hideAllRulesSections();
            document.getElementById('rules-main').classList.remove('hidden');
            document.getElementById('rules-breadcrumb').textContent = 'Правила';
        }

        function showRulesSection(section) {
            hideAllRulesSections();
            document.getElementById('rules-' + section).classList.remove('hidden');
            
            var sectionNames = {
                'distances': 'Правила > Дистанции',
                'combat': 'Правила > Бой', 
                'glossary': 'Правила > Глоссарий'
            };
            document.getElementById('rules-breadcrumb').textContent = sectionNames[section] || 'Правила';
        }

        function hideAllRulesSections() {
            var sections = ['rules-main', 'rules-distances', 'rules-combat', 'rules-glossary'];
            for (var i = 0; i < sections.length; i++) {
                document.getElementById(sections[i]).classList.add('hidden');
            }
        }

        function openRulesLink(section, anchor) {
            rulesFromScreen = getCurrentScreen();
            hideAllScreens();
            document.getElementById('rules').classList.remove('hidden');
            showRulesSection(section);
        }

        function goBackFromRules() {
            hideAllScreens();
            if (rulesFromScreen === 'character-creation') {
                document.getElementById('character-creation').classList.remove('hidden');
            } else if (rulesFromScreen === 'dice-roll') {
                document.getElementById('dice-roll').classList.remove('hidden');
            } else if (rulesFromScreen === 'session-state') {
                document.getElementById('session-state').classList.remove('hidden');
                loadSessionData();
            } else {
                document.getElementById('main-menu').classList.remove('hidden');
            }
        }

        function getCurrentScreen() {
            var screens = ['main-menu', 'character-creation', 'dice-roll', 'session-state'];
            for (var i = 0; i < screens.length; i++) {
                if (!document.getElementById(screens[i]).classList.contains('hidden')) {
                    return screens[i];
                }
            }
            return 'main-menu';
        }

        function hideAllScreens() {
            var screens = ['main-menu', 'character-creation', 'dice-roll', 'session-state', 'rules', 'inventory'];
            for (var i = 0; i < screens.length; i++) {
                document.getElementById(screens[i]).classList.add('hidden');
            }
        }

        // Функции персонажа
        function updatePortrait() {
            var ancestry = document.getElementById('char-ancestry').value;
            var genderRadios = document.getElementsByName('gender');
            var gender = 'male';

            for (var i = 0; i < genderRadios.length; i++) {
                if (genderRadios[i].checked) {
                    gender = genderRadios[i].value;
                    break;
                }
            }

            var portraitImg = document.getElementById('char-portrait');

            if (!ancestry || ancestry === "") {
                // Показываем портрет-заглушку
                portraitImg.src = "images/portraits/placeholder.png";
            } else if (ancestry && portraitImg) {
                var portraitPath = './images/portraits/' + ancestry + '_' + gender + '.png';
                portraitImg.src = portraitPath;
            }
        }

        function updateDomains() {
            var classValue = document.getElementById('char-class').value;
            var domain1Slot = document.getElementById('domain-1');
            var domain2Slot = document.getElementById('domain-2');

            if (classValue && classData[classValue]) {
                var domains = classData[classValue].domains;
                var stats = classData[classValue].stats;
                var baseEvasion = classData[classValue].evasion;
                var hitPoints = classData[classValue].hitPoints;
                
                // Обновляем домены
                var domain1Data = domainData[domains[0]];
                if (domain1Data) {
                    domain1Slot.querySelector('.domain-icon').src = domain1Data.icon;
                    domain1Slot.querySelector('.domain-name').textContent = domain1Data.name;
                }

                var domain2Data = domainData[domains[1]];
                if (domain2Data) {
                    domain2Slot.querySelector('.domain-icon').src = domain2Data.icon;
                    domain2Slot.querySelector('.domain-name').textContent = domain2Data.name;
                }

                // Обновляем характеристики
                if (stats) {
                    document.getElementById('strength').value = stats.strength;
                    document.getElementById('agility').value = stats.agility;
                    document.getElementById('finesse').value = stats.finesse;
                    document.getElementById('instinct').value = stats.instinct;
                    document.getElementById('presence').value = stats.presence;
                    document.getElementById('knowledge').value = stats.knowledge;
                }

                // Рассчитываем финальную броню и уклонение с учетом экипировки
                var finalArmor = 0; // Базовая броня
                var finalEvasion = baseEvasion;
                
                var classEquipment = equipmentData[classValue];
                if (classEquipment) {
                    // Добавляем бонусы от брони
                    if (classEquipment.armor && classEquipment.armor.armorBonus) {
                        finalArmor += classEquipment.armor.armorBonus;
                    }
                    if (classEquipment.armor && classEquipment.armor.evasionBonus) {
                        finalEvasion += classEquipment.armor.evasionBonus;
                    }
                    
                    // Добавляем бонусы от вспомогательного оружия (щита)
                    if (classEquipment.offWeapon && classEquipment.offWeapon.armorBonus) {
                        finalArmor += classEquipment.offWeapon.armorBonus;
                    }
                }

                // Обновляем отображение
                document.getElementById('evasion').textContent = finalEvasion;
                document.getElementById('armor').textContent = finalArmor;

                // Обновляем кубики жизни
                if (hitPoints !== undefined) {
                    updateLifeTrack(hitPoints);
                }
            } else {
                // Сбрасываем все на значения по умолчанию
                domain1Slot.querySelector('.domain-icon').src = "images/domaines/domain-placeholder.svg";
                domain1Slot.querySelector('.domain-name').textContent = "-";
                domain2Slot.querySelector('.domain-icon').src = "images/domaines/domain-placeholder.svg";
                domain2Slot.querySelector('.domain-name').textContent = "-";

                document.getElementById('strength').value = 0;
                document.getElementById('agility').value = 0;
                document.getElementById('finesse').value = 0;
                document.getElementById('instinct').value = 0;
                document.getElementById('presence').value = 0;
                document.getElementById('knowledge').value = 0;

                document.getElementById('evasion').textContent = 0;
                document.getElementById('armor').textContent = 0;
                updateLifeTrack(0);
            }
        }

        function saveCharacter() {
            var name = document.getElementById('char-name').value;
            var ancestry = document.getElementById('char-ancestry').value;
            var background = document.getElementById('char-background').value;
            var charClass = document.getElementById('char-class').value;

            if (!name || !ancestry || !charClass) {
                alert('Пожалуйста, заполните все обязательные поля!');
                return;
            }

            var genderRadios = document.getElementsByName('gender');
            var gender = 'male';
            for (var i = 0; i < genderRadios.length; i++) {
                if (genderRadios[i].checked) {
                    gender = genderRadios[i].value;
                    break;
                }
            }

            var stats = {
                strength: parseInt(document.getElementById('strength').value),
                agility: parseInt(document.getElementById('agility').value),
                finesse: parseInt(document.getElementById('finesse').value),
                instinct: parseInt(document.getElementById('instinct').value),
                presence: parseInt(document.getElementById('presence').value),
                knowledge: parseInt(document.getElementById('knowledge').value)
            };

            var classInfo = classData[charClass];
            var domains = classInfo ? classInfo.domains : [];

            // Получаем финальные значения брони и уклонения (уже рассчитанные)
            var finalEvasion = parseInt(document.getElementById('evasion').textContent);
            var finalArmor = parseInt(document.getElementById('armor').textContent);

            currentCharacter = {
                name: name,
                ancestry: ancestry,
                background: background,
                gender: gender,
                class: charClass,
                stats: stats,
                domains: domains,
                evasion: finalEvasion, // Сохраняем финальное значение
                armor: finalArmor,     // Сохраняем финальное значение
                hitPoints: classInfo ? classInfo.hitPoints : 5,
                maxHitPoints: classInfo ? classInfo.hitPoints : 5,
                hopeTrack: 2,
                dramaTrack: 0
            };

            if (typeof(Storage) !== "undefined") {
                localStorage.setItem('daggerheart_character', JSON.stringify(currentCharacter));
            }

            alert('Персонаж создан успешно!');
            showMainMenu();
            updateMenuButtons(); 
        }

        // Обновление кубов жизни
        function updateLifeTrack(filledCount) {
            var lifeTrack = document.getElementById('life-track');
            var boxes = lifeTrack.querySelectorAll('.track-box');
            
            for (var i = 0; i < boxes.length; i++) {
                if (i < filledCount) {
                    boxes[i].classList.remove('empty');
                    boxes[i].classList.add('filled');
                } else {
                    boxes[i].classList.remove('filled');
                    boxes[i].classList.add('empty');
                }
            }
        }

        // Обновление кубов драмы
        function updateDramaTrack(filledCount) {
            var dramaTrack = document.getElementById('drama-track');
            var boxes = dramaTrack.querySelectorAll('.track-box');
            
            for (var i = 0; i < boxes.length; i++) {
                if (i < filledCount) {
                    boxes[i].classList.remove('empty');
                    boxes[i].classList.add('filled');
                } else {
                    boxes[i].classList.remove('filled');
                    boxes[i].classList.add('empty');
                }
            }
        }
        
        // Модальные окна
        function showClassInfo() {
            var classValue = document.getElementById('char-class').value;
            var modal = document.getElementById('class-modal');
            var title = document.getElementById('modal-class-title');
            var description = document.getElementById('modal-class-description');

            if (classValue && classData[classValue]) {
                title.textContent = classData[classValue].name;
                if (classData[classValue].description.includes('<')) {
                    description.innerHTML = classData[classValue].description;
                } else {
                    description.textContent = classData[classValue].description;
                }
            } else {
                title.textContent = "Информация о классе";
                description.textContent = "Сначала выберите класс из списка.";
            }

            modal.style.display = 'block';
        }

        function closeClassModal() {
            document.getElementById('class-modal').style.display = 'none';
        }

        function showAncestryInfo() {
            var ancestry = document.getElementById('char-ancestry').value;
            var modal = document.getElementById('ancestry-modal');
            var title = document.getElementById('modal-ancestry-title');
            var description = document.getElementById('modal-ancestry-description');

            if (ancestry && ancestryData[ancestry]) {
                title.textContent = ancestryData[ancestry].name;
                if (ancestryData[ancestry].description.includes('<')) {
                    description.innerHTML = ancestryData[ancestry].description;
                } else {
                    description.textContent = ancestryData[ancestry].description;
                }
            } else {
                title.textContent = "Информация о родословной";
                description.textContent = "Сначала выберите родословную из списка.";
            }

            modal.style.display = 'block';
        }

        function closeAncestryModal() {
            document.getElementById('ancestry-modal').style.display = 'none';
        }

        function showBackgroundInfo() {
            var backgroundValue = document.getElementById('char-background').value;
            var modal = document.getElementById('background-modal');
            var title = document.getElementById('modal-background-title');
            var description = document.getElementById('modal-background-description');

            if (backgroundValue && backgroundData[backgroundValue]) {
                title.textContent = backgroundData[backgroundValue].name;
                if (backgroundData[backgroundValue].description.includes('<')) {
                    description.innerHTML = backgroundData[backgroundValue].description;
                } else {
                    description.textContent = backgroundData[backgroundValue].description;
                }
            } else {
                title.textContent = "Информация о происхождении";
                description.textContent = "Сначала выберите происхождение из списка.";
            }

            modal.style.display = 'block';
        }

        function closeBackgroundModal() {
            document.getElementById('background-modal').style.display = 'none';
        }

        // Функция загрузки предметов инвентаря
        function loadInventoryItems() {
            
            if (!currentCharacter || !currentCharacter.class) {
                clearInventoryDisplay();
                return;
            }

            var classEquipment = equipmentData[currentCharacter.class];
            if (!classEquipment) {
                clearInventoryDisplay();
                return;
            }

            // Загружаем броню
            if (classEquipment.armor) {
                document.getElementById('armor-image').src = classEquipment.armor.image;
                document.getElementById('armor-name').textContent = classEquipment.armor.name;
                document.getElementById('armor-defense').textContent = classEquipment.armor.defense;
                document.getElementById('armor-type').textContent = classEquipment.armor.type;
                document.getElementById('armor-trait').textContent = classEquipment.armor.trait;
            }

            // Загружаем основное оружие
            if (classEquipment.mainWeapon) {
                console.log('Loading main weapon:', classEquipment.mainWeapon);
                document.getElementById('main-weapon-image').src = classEquipment.mainWeapon.image;
                document.getElementById('main-weapon-name').textContent = classEquipment.mainWeapon.name;
                document.getElementById('main-weapon-damage').textContent = classEquipment.mainWeapon.damage;
                document.getElementById('main-weapon-type').textContent = classEquipment.mainWeapon.type;
                document.getElementById('main-weapon-range').textContent = classEquipment.mainWeapon.range;
                document.getElementById('main-weapon-trait').textContent = classEquipment.mainWeapon.trait;
            }

            // Загружаем вспомогательное оружие
            if (classEquipment.offWeapon) {
                console.log('Loading off weapon:', classEquipment.offWeapon);
                var offWeaponImg = document.getElementById('off-weapon-image');
                offWeaponImg.src = classEquipment.offWeapon.image;
                
                // Добавляем класс для затемнения, если это вторая рука двуручного оружия
                if (classEquipment.offWeapon.isSecondHand) {
                    offWeaponImg.classList.add('second-hand');
                } else {
                    offWeaponImg.classList.remove('second-hand');
                }
                
                document.getElementById('off-weapon-name').textContent = classEquipment.offWeapon.name;
                document.getElementById('off-weapon-damage').textContent = classEquipment.offWeapon.damage;
                document.getElementById('off-weapon-type').textContent = classEquipment.offWeapon.type;
                document.getElementById('off-weapon-range').textContent = classEquipment.offWeapon.range;
                document.getElementById('off-weapon-trait').textContent = classEquipment.offWeapon.trait;
            }
        }

        // Функция очистки инвентаря
        function clearInventoryDisplay() {
            // Очищаем броню
            document.getElementById('armor-image').src = "";
            document.getElementById('armor-name').textContent = "Нет брони";
            document.getElementById('armor-defense').textContent = "-";
            document.getElementById('armor-type').textContent = "-";
            document.getElementById('armor-trait').textContent = "-";

            // Очищаем основное оружие
            document.getElementById('main-weapon-image').src = "";
            document.getElementById('main-weapon-name').textContent = "Нет оружия";
            document.getElementById('main-weapon-damage').textContent = "-";
            document.getElementById('main-weapon-type').textContent = "-";
            document.getElementById('main-weapon-range').textContent = "-";
            document.getElementById('main-weapon-trait').textContent = "-";

            // Очищаем вспомогательное оружие
            document.getElementById('off-weapon-image').src = "";
            document.getElementById('off-weapon-name').textContent = "Нет оружия";
            document.getElementById('off-weapon-damage').textContent = "-";
            document.getElementById('off-weapon-type').textContent = "-";
            document.getElementById('off-weapon-range').textContent = "-";
            document.getElementById('off-weapon-trait').textContent = "-";
        }        

    // Система модальных пончиков
        // Функция показа уведомления о характеристиках
        function showStatsMessage() {
            var classValue = document.getElementById('char-class').value;
            
            // Показываем уведомление только если выбран класс
            if (classValue && classData[classValue]) {
                document.getElementById('stats-notification-modal').style.display = 'block';
            }
        }

        // Функция закрытия уведомления
        function closeStatsNotification() {
            document.getElementById('stats-notification-modal').style.display = 'none';
        }

        // Закрытие уведомления по клику вне окна
        window.onclick = function(event) {
            var modal = document.getElementById('stats-notification-modal');
            if (event.target == modal) {
                closeStatsNotification();
            }
            
            // Сохраняем существующие обработчики для других модальных окон
            var ancestryModal = document.getElementById('ancestry-modal');
            if (event.target == ancestryModal) {
                closeAncestryModal();
            }
            
            var classModal = document.getElementById('class-modal');
            if (event.target == classModal) {
                closeClassModal();
            }
            
            var backgroundModal = document.getElementById('background-modal');
            if (event.target == backgroundModal) {
                closeBackgroundModal();
            }
        }

        // Система бросков кубиков
        function rollDice() {
            var rollButton = document.getElementById('roll-button');
            var hopeDice = document.getElementById('hope-dice');
            var fearDice = document.getElementById('fear-dice');
            var resultDiv = document.getElementById('roll-result');

            rollButton.disabled = true;
            hopeDice.classList.add('rolling');
            fearDice.classList.add('rolling');

            var rollCount = 0;
            var rollInterval = setInterval(function() {
                hopeDice.textContent = Math.floor(Math.random() * 12) + 1;
                fearDice.textContent = Math.floor(Math.random() * 12) + 1;
                rollCount++;

                if (rollCount >= 10) {
                    clearInterval(rollInterval);
                    finishRoll();
                }
            }, 50);
        }

        function finishRoll() {
            var hopeDice = document.getElementById('hope-dice');
            var fearDice = document.getElementById('fear-dice');
            var resultDiv = document.getElementById('roll-result');
            var rollButton = document.getElementById('roll-button');

            var hopeRoll = Math.floor(Math.random() * 12) + 1;
            var fearRoll = Math.floor(Math.random() * 12) + 1;

            hopeDice.textContent = hopeRoll;
            fearDice.textContent = fearRoll;

            hopeDice.classList.remove('rolling');
            fearDice.classList.remove('rolling');

            var difficulty = parseInt(document.getElementById('difficulty').value);
            var traitMod = getTraitModifier();
            var total = Math.max(hopeRoll, fearRoll) + traitMod;

            var resultText = '';
            var resultClass = '';

            if (hopeRoll === fearRoll) {
                resultText = '🌟 КРИТИЧЕСКИЙ УСПЕХ! (' + hopeRoll + '/' + fearRoll + ' + ' + traitMod + ' = ' + total + ')';
                resultClass = 'critical';
            } else if (total >= difficulty) {
                if (hopeRoll > fearRoll) {
                    resultText = '✅ Успех с Надеждой! (' + total + ' ≥ ' + difficulty + ')';
                    resultClass = 'success';
                } else {
                    resultText = '✅ Успех со Страхом (' + total + ' ≥ ' + difficulty + ')';
                    resultClass = 'success';
                }
            } else {
                resultText = '❌ Неудача (' + total + ' < ' + difficulty + ')';
                resultClass = 'failure';
            }

            resultDiv.innerHTML = resultText;
            resultDiv.className = 'roll-result ' + resultClass;
            resultDiv.classList.remove('hidden');

            rollButton.disabled = false;
        }

        function getTraitModifier() {
            var traitSelect = document.getElementById('trait-modifier');
            var selectedTrait = traitSelect.value;

            if (selectedTrait === '0') {
                return 0;
            }

            return Math.floor(Math.random() * 6) - 2;
        }

        // Функции состояния сессии
        function loadSessionData() {
            if (typeof(Storage) !== "undefined") {
                var savedCharacter = localStorage.getItem('daggerheart_character');
                if (savedCharacter) {
                    currentCharacter = JSON.parse(savedCharacter);
                }
            }
            updateSessionDisplay();
        }

        function updateSessionDisplay() {

            var characterInfo = document.getElementById('character-info');
            var inventoryInfo = document.getElementById('inventory-info');

            if (currentCharacter) {
                characterInfo.innerHTML = 
                    '<button class="button" onclick="showCharacterSheet()">' + 
                    '👤 ' + currentCharacter.name + 
                    '</button>';
            
                inventoryInfo.innerHTML = '<button class="button" onclick="showInventory()">🎒 Открыть инвентарь</button>';
       
       // кнопка удаления сразу в меню
       //   if (currentCharacter) {
       //       characterInfo.innerHTML = 
       //          '<button class="button" onclick="showCharacterSheet()">' + 
       //           '👤 ' + currentCharacter.name + 
       //           '</button>' +
       //           '<button class="button secondary" onclick="deleteCharacter()" style="margin-top: 8px;">' +
       //           '🗑️ Удалить персонажа' +
       //           '</button>';

       //        inventoryInfo.innerHTML = '<button class="button" onclick="showInventory()">🎒 Открыть инвентарь</button>';
                
            } else {
                characterInfo.innerHTML = '<p>Персонаж не создан</p>';
                inventoryInfo.innerHTML = '<p>Персонаж не создан</p>';
            }

            var sceneInfo = document.getElementById('current-scene');
            if (sessionData.scene) {
                sceneInfo.innerHTML = '<p>' + sessionData.scene + '</p>';
            } else {
                sceneInfo.innerHTML = '<p>Сцена не установлена</p>';
            }
        }

        // Показать лист персонажа (только просмотр)
        function showCharacterSheet() {
            hideAllScreens();
            document.getElementById('character-creation').classList.remove('hidden');
            
            // Заполняем все поля данными персонажа
            document.getElementById('char-name').value = currentCharacter.name;
            document.getElementById('char-ancestry').value = currentCharacter.ancestry;
            document.getElementById('char-background').value = currentCharacter.background || '';
            document.getElementById('char-class').value = currentCharacter.class;
            
            // Устанавливаем гендер
            var genderRadios = document.getElementsByName('gender');
            for (var i = 0; i < genderRadios.length; i++) {
                genderRadios[i].checked = (genderRadios[i].value === currentCharacter.gender);
            }
            
            // Заполняем характеристики
            document.getElementById('strength').value = currentCharacter.stats.strength;
            document.getElementById('agility').value = currentCharacter.stats.agility;
            document.getElementById('finesse').value = currentCharacter.stats.finesse;
            document.getElementById('instinct').value = currentCharacter.stats.instinct;
            document.getElementById('presence').value = currentCharacter.stats.presence;
            document.getElementById('knowledge').value = currentCharacter.stats.knowledge;
            
            // Устанавливаем защиту
            document.getElementById('evasion').textContent = currentCharacter.evasion;
            document.getElementById('armor').textContent = currentCharacter.armor;
            
            // Обновляем домены
            updateDomainsDisplay();
            
            // Обновляем треки
            updateLifeTrack(currentCharacter.hitPoints);
            updateDramaTrack(currentCharacter.dramaTrack);
            updateHopeTrack(currentCharacter.hopeTrack);
            
            // Обновляем портрет
            updatePortrait();
            
            // Делаем все поля readonly
            makeFieldsReadonly();
            
            // Меняем кнопку сохранения на кнопки управления
            updateCharacterSheetButtons();
        }

        // Обновление отображения доменов
        function updateDomainsDisplay() {
            if (currentCharacter && currentCharacter.domains) {
                var domain1Slot = document.getElementById('domain-1');
                var domain2Slot = document.getElementById('domain-2');
                
                // Первый домен
                if (currentCharacter.domains[0] && domainData[currentCharacter.domains[0]]) {
                    var domain1Data = domainData[currentCharacter.domains[0]];
                    domain1Slot.querySelector('.domain-icon').src = domain1Data.icon;
                    domain1Slot.querySelector('.domain-name').textContent = domain1Data.name;
                }
                
                // Второй домен
                if (currentCharacter.domains[1] && domainData[currentCharacter.domains[1]]) {
                    var domain2Data = domainData[currentCharacter.domains[1]];
                    domain2Slot.querySelector('.domain-icon').src = domain2Data.icon;
                    domain2Slot.querySelector('.domain-name').textContent = domain2Data.name;
                }
            }
        }

        // Обновление трека надежды
        function updateHopeTrack(filledCount) {
            var hopeTrack = document.getElementById('hope-track');
            var boxes = hopeTrack.querySelectorAll('.track-box');
            
            for (var i = 0; i < boxes.length; i++) {
                if (i < filledCount) {
                    boxes[i].classList.remove('empty');
                    boxes[i].classList.add('filled');
                } else {
                    boxes[i].classList.remove('filled');
                    boxes[i].classList.add('empty');
                }
            }
        }

        // Делает все поля только для чтения
        function makeFieldsReadonly() {
            document.getElementById('char-name').readOnly = true;
            document.getElementById('char-ancestry').disabled = true;
            document.getElementById('char-background').disabled = true;
            document.getElementById('char-class').disabled = true;
            
            var genderRadios = document.getElementsByName('gender');
            for (var i = 0; i < genderRadios.length; i++) {
                genderRadios[i].disabled = true;
            }
        }

        // Восстанавливает редактирование полей
        function makeFieldsEditable() {
            document.getElementById('char-name').readOnly = false;
            document.getElementById('char-ancestry').disabled = false;
            document.getElementById('char-background').disabled = false;
            document.getElementById('char-class').disabled = false;
            
            var genderRadios = document.getElementsByName('gender');
            for (var i = 0; i < genderRadios.length; i++) {
                genderRadios[i].disabled = false;
            }
        }

        // Обновляет кнопки в зависимости от режима (создание/просмотр)
        function updateCharacterSheetButtons() {
            var buttonContainer = document.querySelector('#character-creation .card');
            var existingButtons = buttonContainer.querySelectorAll('.button');
            
            // Удаляем старые кнопки
            for (var i = existingButtons.length - 1; i >= 0; i--) {
                existingButtons[i].remove();
            }
            
            // Добавляем новые кнопки для просмотра персонажа
            var editButton = document.createElement('button');
            editButton.className = 'button';
            editButton.onclick = editCharacter;
            editButton.innerHTML = '✏️ Редактировать';
            
            var deleteButton = document.createElement('button');
            deleteButton.className = 'button secondary';
            deleteButton.onclick = deleteCharacter;
            deleteButton.innerHTML = '🗑️ Удалить персонажа';
            
            var backButton = document.createElement('button');
            backButton.className = 'button secondary';
            backButton.onclick = showSession;
            backButton.innerHTML = '← Назад';
            
            buttonContainer.appendChild(editButton);
            buttonContainer.appendChild(deleteButton);
            buttonContainer.appendChild(backButton);
        }

        // Функция редактирования персонажа
        function editCharacter() {
            makeFieldsEditable();
            
            // Меняем кнопки на кнопки редактирования
            var buttonContainer = document.querySelector('#character-creation .card');
            var existingButtons = buttonContainer.querySelectorAll('.button');
            
            // Удаляем старые кнопки
            for (var i = existingButtons.length - 1; i >= 0; i--) {
                existingButtons[i].remove();
            }
            
            // Добавляем кнопки редактирования
            var saveButton = document.createElement('button');
            saveButton.className = 'button';
            saveButton.onclick = saveCharacter;
            saveButton.innerHTML = '✅ Сохранить изменения';
            
            var cancelButton = document.createElement('button');
            cancelButton.className = 'button secondary';
            cancelButton.onclick = showCharacterSheet;
            cancelButton.innerHTML = '❌ Отменить';
            
            buttonContainer.appendChild(saveButton);
            buttonContainer.appendChild(cancelButton);
        }

        // Функция удаления персонажа
        function deleteCharacter() {
            if (confirm('Вы уверены, что хотите удалить персонажа?')) {
                currentCharacter = null;
                if (typeof(Storage) !== "undefined") {
                    localStorage.removeItem('daggerheart_character');
                }
                updateMenuButtons();
                showSession();
            }
        }

        function showInventory() {
            hideAllScreens();
            document.getElementById('inventory').classList.remove('hidden');
            loadInventoryItems();
        }
        
        // Функция показа уведомления об экипировке
        function showInventoryMessage() {
            // Обновляем текст модального окна для инвентаря
            var modal = document.getElementById('stats-notification-modal');
            var title = modal.querySelector('.notification-title');
            var text = modal.querySelector('.notification-text');

            modal.style.display = 'block';
        }

        // Функция проверки наличия персонажа и обновления кнопки игры
        function updateMenuButtons() {
            var gameButton = document.getElementById('game-button');
            var sessionButton = document.getElementById('session-button');
            
            if (currentCharacter) {
                // Персонаж создан - активируем обе кнопки
                gameButton.className = 'button';
                gameButton.disabled = false;
                sessionButton.className = 'button';
                sessionButton.disabled = false;
            } else {
                // Персонажа нет - делаем кнопки неактивными
                gameButton.className = 'button secondary';
                gameButton.disabled = false; // Оставляем кликабельной для показа сообщения
                sessionButton.className = 'button secondary';
                sessionButton.disabled = false; // Оставляем кликабельной для показа сообщения
            }
        }

        async function startGame() {
            if (!currentCharacter) {
                alert('Для начала игры создайте персонажа');
                return;
            }
            
            hideAllScreens();
            document.getElementById('game-screen').classList.remove('hidden');
            
            // Инициализируем игру
            await initializeGame();
        }

        async function initializeGame() {
            addToGameLog('system', 'Подключение к ИИ гейм-мастеру...');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/gm_action`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'Начать новую игру',
                        character: currentCharacter,
                        game_state: gameState
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateGameScreen(result.data);
                    addToGameLog('system', '✅ Соединение с ГМ установлено');
                } else {
                    addToGameLog('system', `❌ Ошибка ГМ: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Ошибка инициализации:', error);
                addToGameLog('system', '❌ Не удалось подключиться к серверу ГМ');
            }
        }

        async function sendPlayerAction() {
            const actionText = document.getElementById('player-action').value.trim();
            if (!actionText) return;
            
            // Блокируем кнопку во время обработки
            const sendBtn = document.getElementById('send-action-btn');
            sendBtn.disabled = true;
            sendBtn.textContent = '⏳ Обработка...';
            
            // Добавляем действие в лог
            addToGameLog('player', actionText);
            document.getElementById('player-action').value = '';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/gm_action`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: actionText,
                        character: currentCharacter,
                        game_state: gameState
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateGameScreen(result.data);
                    
                    // Если нужен бросок, запрашиваем его
                    if (result.data.requires_roll) {
                        await handleSkillCheck(result.data.requires_roll);
                    }
                } else {
                    addToGameLog('system', `❌ Ошибка ГМ: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Ошибка отправки действия:', error);
                addToGameLog('system', '❌ Ошибка связи с ГМ');
            } finally {
                // Разблокируем кнопку
                sendBtn.disabled = false;
                sendBtn.textContent = '📤 Отправить действие';
            }
        }

        async function handleSkillCheck(rollData) {
            const trait = rollData.trait;
            const difficulty = rollData.difficulty;
            const reason = rollData.reason;
            
            addToGameLog('system', `🎲 Требуется проверка ${trait} (сложность ${difficulty}): ${reason}`);
            
            // Получаем модификатор характеристики
            const traitModifier = currentCharacter.stats[trait] || 0;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/roll_dice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        trait_modifier: traitModifier
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayDiceResult(result.data, difficulty);
                } else {
                    addToGameLog('system', '❌ Ошибка броска кубиков');
                }
                
            } catch (error) {
                console.error('Ошибка броска:', error);
                addToGameLog('system', '❌ Ошибка системы бросков');
            }
        }

        function displayDiceResult(rollData, difficulty) {
            const { hope_dice, fear_dice, modifier, total, is_critical, dominant_die } = rollData;
            
            let resultText = `🎲 Результат: Надежда ${hope_dice}, Страх ${fear_dice}`;
            if (modifier !== 0) {
                resultText += ` + ${modifier} = ${total}`;
            }
            
            let outcome;
            if (is_critical) {
                outcome = '🌟 КРИТИЧЕСКИЙ УСПЕХ!';
            } else if (total >= difficulty) {
                outcome = dominant_die === 'hope' ? 
                    '✅ Успех с Надеждой!' : 
                    '✅ Успех со Страхом';
            } else {
                outcome = '❌ Неудача';
            }
            
            addToGameLog('system', `${resultText}\n${outcome}`);
        }

        function updateGameScreen(gmData) {
            // Обновляем описание сцены
            if (gmData.scene_description) {
                addToGameLog('gm', gmData.scene_description);
                gameState.scene = gmData.scene_description;
            }
            
            // Обновляем локацию
            if (gmData.location) {
                document.getElementById('scene-location').textContent = gmData.location;
                gameState.location = gmData.location;
            }
            
            // Обновляем предложения действий
            if (gmData.action_suggestions) {
                updateActionSuggestions(gmData.action_suggestions);
            }
        }

        function updateActionSuggestions(suggestions) {
            const container = document.getElementById('suggestions-list');
            container.innerHTML = '';
            
            suggestions.forEach(suggestion => {
                const button = document.createElement('button');
                button.className = 'button secondary';
                button.style.marginBottom = '4px';
                button.textContent = suggestion;
                button.onclick = () => {
                    document.getElementById('player-action').value = suggestion;
                };
                container.appendChild(button);
            });
            
            document.getElementById('action-suggestions').classList.remove('hidden');
        }

        function addToGameLog(type, content) {
            const gameLog = document.getElementById('game-log');
            const messageDiv = document.createElement('div');
            messageDiv.className = `${type}-message`;
            
            const prefixes = {
                'gm': '🎭 ГМ:',
                'player': '👤 Вы:',
                'system': '⚙️ Система:'
            };
            
            messageDiv.innerHTML = `<strong>${prefixes[type]}</strong> ${content.replace(/\n/g, '<br>')}`;
            
            gameLog.appendChild(messageDiv);
            gameLog.scrollTop = gameLog.scrollHeight;
            
            // Сохраняем в состояние игры
            gameState.log.push({type, content, timestamp: Date.now()});
        }

        async function quickRoll(trait) {
            if (!currentCharacter) return;
            
            const traitModifier = currentCharacter.stats[trait] || 0;
            const traitNames = {
                'strength': 'Сила',
                'agility': 'Ловкость', 
                'finesse': 'Грация',
                'instinct': 'Интуиция',
                'presence': 'Харизма',
                'knowledge': 'Интеллект'
            };
            
            addToGameLog('player', `Бросаю проверку ${traitNames[trait]}`);
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/roll_dice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        trait_modifier: traitModifier
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const { hope_dice, fear_dice, modifier, total } = result.data;
                    addToGameLog('system', `🎲 ${traitNames[trait]}: Надежда ${hope_dice}, Страх ${fear_dice} + ${modifier} = ${total}`);
                }
                
            } catch (error) {
                addToGameLog('system', '❌ Ошибка броска');
            }
        }

        function pauseGame() {
            addToGameLog('system', '⏸️ Игра приостановлена');
        }

        function endGame() {
            if (confirm('Завершить игру?')) {
                showMainMenu();
            }
        }
        
        // Инициализация
        window.addEventListener('load', function() {
            console.log('Приложение загружено');
        });
    </script>
</body>
</html>